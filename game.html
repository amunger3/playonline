<!DOCTYPE html>
<html>

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Super Master Mind</title> <!-- (this title will be overwritten) -->
    <meta name="title" content="Super Master Mind">
    <meta name="description" content="Play Super Master Mind / Code breaker online, assisted by a calculator which knows the optimal strategy!">
    <meta name="keywords" content="super master mind, code breaker, game, online, optimal strategy, javascript">

    <!-- Remote console at http://console.re/supermastermind displaying console text (provided all calls to "console.log(xxx)" are replaced by "console.re.log(xxx)")
         and console errors (provided the .js scripts to be debugged are copied/pasted directly into this HTML file between <script>...</script> tags,
         otherwise error details, among which error line numbers, will be lost):
      <script src="https://console.re/connector.js" data-channel="supermastermind" id="consolerescript"></script>
      <script>console.re.log('remote log enabled!');</script>
    -->

    <style>
      /* *** Main styles *** */
      body {
        font-family: 'Verdana';
        margin: 0%;
        padding: 0%;
        /* border: thin solid white; */
        color: #777777;
        font-size: 11px;
        background: black;
      }
      #my_canvas {
        margin: 0;
        padding: 0;
        border: 2px solid purple; /* (duplicated in SuperMasterMind.js for proper canvas's width & height calculation) */
        background: white;
        width: 98.5%;
        height: 90%;
        border-radius: 1%;
        zoom: 1.0; /* (used by Chrome, ignored by Firefox) */
      }
      /* *** Classes for button styling using CSS *** */
      .button {
        font-family: Verdana;
        background-color: white;
        border: 2px solid purple;
        color: black;
        padding: 7px 8px 7px 8px; /* top right bottom left */
        text-align: center;
        text-decoration: none;
        // font-size: 15px;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        display: block;
        margin-top: 5px;
        margin-bottom: 5px;
        border-radius: 20%;
        -webkit-backface-visibility: visible;
      }
      .button:hover {
        background-color: purple;
        color: white;
      }
      .disabled {
          opacity: 0.4;
          font-weight: normal;
          cursor: not-allowed;
      }
      /* Safari 4.0 - 8.0 */
      @-webkit-keyframes glowing {
        0%   {background-color: white;}
        20%  {background-color: white;}
        33%  {background-color: purple;}
        47%  {background-color: white;}
        60%  {background-color: purple;}
        73%  {background-color: white;}
        87%  {background-color: purple;}
        100% {background-color: white;}
      }
      /* Standard syntax */
      @keyframes glowing {
        0%   {background-color: white;}
        20%  {background-color: white;}
        33%  {background-color: purple;}
        47%  {background-color: white;}
        60%  {background-color: purple;}
        73%  {background-color: white;}
        87%  {background-color: purple;}
        100% {background-color: white;}
      }

      .blinking {
        -webkit-animation-name: glowing; /* Safari 4.0 - 8.0 */
        -webkit-animation-duration: 3.75s; /* Safari 4.0 - 8.0 */
        animation-name: glowing;
        animation-duration: 3.75s;
        -webkit-backface-visibility: hidden;
       }
      .fast_blinking {
        -webkit-animation-name: glowing; /* Safari 4.0 - 8.0 */
        -webkit-animation-duration: 2.75s; /* Safari 4.0 - 8.0 */
        animation-name: glowing;
        animation-duration: 2.75s;
        -webkit-backface-visibility: hidden;
       }

      .radio {
        font-family: Verdana;
        color: black;
        padding: 0 0 0 0; /* top right bottom left */
        text-align: left;
        text-decoration: none;
        // font-size: 14px;
        font-weight: bold;
        width: 100%;
        box-shadow: none;
        /* text not selectable */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .game_loading /* (used during page loading) */
      { position: fixed;
        height: 100%;
        width: 100%;
        top:0;
        left: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index:11111;
        font-size: 20px;
        text-align: center;
        padding-top: 222px;
        color: #fff;
        /* text not selectable */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .page_transition /* (used during page transition) */
      { position: fixed;
        height: 100%;
        width: 100%;
        top:0;
        left: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index:11111;
        font-size: 20px;
        text-align: center;
        padding-top: 222px;
        color: #fff;
        /* text not selectable */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .game_aborted /* (used at game abortion) */
      { position: fixed;
        height: 100%;
        width: 100%;
        top:0;
        left: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index:11111;
        font-size: 20px;
        text-align: center;
        padding-top: 222px;
        color: #fff;
        /* text not selectable */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

    </style>

    <script>
      try {
        eval('"use strict"; class foo {}; let test_let_inst = 1;'); // Interner Explorer does not support classes and old versions of Safari (< 10) will fail on the "let" instruction (error tested on Safari 9.1)
      } catch (err) {
        alert("Your browser cannot run this game.\nThis game can be run in the last versions of Chrome, Firefox and Safari (v10 or above): update your browser version if necessary.\nThis game cannot be run in Internet Explorer.");
      }
      if (typeof(Worker) == "undefined") {
        alert("Your browser cannot run this game because it does not support Web workers: update your browser version if necessary.");
      }
      var nbGamesPlayedAndWon = 0;
      var nbGamesPlayed = 0;
      var nbCodesPlayed = 0;
      var firstgamegeoloc = "fa";
    </script>
    <script src='lib/jquery-3.2.1.min.js'></script>
    <script>
      // Animation during page loading:
      // 1) when document is ready
      $(document).ready(function () {
        console.log("(ready)");
        // Less beautiful + can put some problems with Chrome while drawing canvas: $(".mainxxx").hide(); // hide the mainxxx div
      });
      // 2) when all elements of the page are completely loaded
      $(window).on('load', function() {
        console.log("(on load)");
        $(".game_loading").fadeOut("slow"); // game_loading div fades out
        // Less beautiful + can put some problems with Chrome while drawing canvas: $(".mainxxx").fadeIn("slow"); // mainxxx div fades in
      });
      // 2') Defense timeout to allow interactions with the page
      setTimeout("console.log('(on load timeout)');$('.game_loading').fadeOut('slow');", 5000); // game_loading div fades out

      $(window).on('beforeunload', function() { // Ask for a confirmation on window exit when a game is ongoing (***)
        try {
          if (gameOnGoing() && (currentAttemptNumber > 1)) {
            return "Do you really want to abort and lose current game?"; // (message not displayed by all browsers, some browsers will display a generic message instead - code duplicated)
          }
        }
        catch (exc) {
          console.log("error encountered at game abortion: " + exc);
          return; // (no confirmation asked)
        }
      });

      function makeid() {
        let text = "";
        let possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        for (let i = 0; i < 5; i++) {
          text += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return text;
      }

      let firstAccess = false;
      if (typeof(Storage) !== 'undefined') {
        if (!localStorage.firstgameaccessdone) {
          localStorage.firstgameaccessdone = "first game access done";
          firstAccess = true;
        }
        if (!localStorage.firstaccessid) {
          let firstaccessid = 'GA - ' + makeid() + ' - ' + new Date();
          localStorage.firstaccessid = firstaccessid;
        }
      }
    </script>

    <link rel='stylesheet' type='text/css' href='lib/tingle-master/dist/tingle.min.css'>
  </head>

  <body onresize="draw_graphic();" onunload="/* See (***) */ console.log('exit...');storeFirstAccess('game', 777, 777 /* (a too low value here will not work) */, 'debug-out');">

    <div class="game_loading">
      <img src="img/loading.gif"><br>
      Loading...
    </div>

    <div class="page_transition" style='display:none;'>
    </div>

    <div class="game_aborted" style='display:none;'>
      Current game was lost because you aborted it<br>
      Score: 0<br>
      <img src="img/loading.gif"><br>
      Starting a new game...
    </div>

    <!-- HTML controls and canvas -->

    <table id='my_table' style='background:#E3E3E3;width:75%;height:90%;position:absolute;left:12.5%;top:2%;border:5px ridge white;border-radius:1%;margin:0;padding:0;'>
      <tr style='height:100%;'>
        <td style='width:0.4%;margin:0;padding:0;'></td>
        <td style='width:6.2%;margin:0;padding:0;vertical-align:middle;text-align:center;'>
          <input id='newGameButton' class='button' type='button' value='NEW GAME' title='Start a new game' onclick='newGameButtonClick(0)' onfocus='this.blur()'>
          <form action=''>
            <label class='radio' title='Very easy'><input id='columnslabel_3b' type='radio' value='3' name='nbColumnsSelection' style='vertical-align:middle;' onclick='newGameButtonClick(3)'><span id='columnslabel_3' class='radio' style='vertical-align:middle;'> 3 columns <br></span></label>
            <label class='radio' title='Master Mind'><input id='columnslabel_4b' type='radio' value='4' name='nbColumnsSelection' style='vertical-align:middle;' onclick='newGameButtonClick(4)'><span id='columnslabel_4' class='radio' style='vertical-align:middle;'> 4 columns <br></span></label>
            <label class='radio' title='Super Master Mind'><input id='columnslabel_5b' type='radio' value='5' name='nbColumnsSelection' style='vertical-align:middle;' onclick='newGameButtonClick(5)'><span id='columnslabel_5' class='radio' style='vertical-align:middle;'> 5 columns <br></span></label>
            <label class='radio' title='Advanced Master Mind'><input id='columnslabel_6b' type='radio' value='6' name='nbColumnsSelection' style='vertical-align:middle;' onclick='newGameButtonClick(6)'><span id='columnslabel_6' class='radio' style='vertical-align:middle;'> 6 columns <br></span></label>
            <label class='radio' title='Ultra Master Mind'><input id='columnslabel_7b' type='radio' value='7' name='nbColumnsSelection' style='vertical-align:middle;' onclick='newGameButtonClick(7)'><span id='columnslabel_7' class='radio' style='vertical-align:middle;'> 7 columns <br></span></label>
          </form>
          <input id='resetCurrentCodeButton' class='button disabled' type='button' value='Reset current code' title='Reset current code' onclick='resetCurrentCodeButtonClick()' onfocus='this.blur()' disabled>
          <input id='playRandomCodeButton' class='button disabled' type='button' value='Play random code' title='Play a random code' onclick='playRandomCodeButtonClick()' onfocus='this.blur()' disabled>
          <input id='revealSecretColorButton' class='button disabled' type='button' value='Reveal secret color' title='Reveal a color of the secret code' onclick='revealSecretColorButtonClick()' onfocus='this.blur()' disabled>
          <input id='showPossibleCodesButton' class='button disabled' type='button' value='Show possible codes' title='Show possible codes at each stage of the game (when game is over)' onfocus='this.blur()' onclick='showPossibleCodesButtonClick()' disabled>
        </td>
        <td style='width:0.4%;margin:0;padding:0;'></td>
        <td style='width:93%;margin:0;padding:0;vertical-align:middle;align:right;text-align:left;'><canvas id='my_canvas'><font color=red>Error: HTML canvas are not supported!</font></canvas></td>
      </tr>
    </table>

    <!-- Display extra text and pictures -->

    <p align='right'>
      <script>
        if (typeof(Storage) !== 'undefined') {
          if (localStorage.firstname) {
            document.write("<font color=#DDDDDD><span id='welcome_id' style='float:left;'>&nbsp;&nbsp;Welcome <b><font color=yellow>" + localStorage.firstname + "</font></b>!</span></font>");
            setTimeout(function() {
              $("#welcome_id").fadeOut().empty();
            }, 60000);
          }
        }
      </script>
      <b><a href='index.html'>&#x2302; Main page</a></b>&nbsp;&nbsp;&nbsp;<br>
      <b><a href='screenshots.html'>&#x2302; Game examples</a></b>&nbsp;&nbsp;&nbsp;<br>
      <b><a href='optimal_strategy.html'>&#x2302; Optimal strategy</a></b>&nbsp;&nbsp;&nbsp;<br>
      <b><a href='contact_info.html'>&#x2302; Contact info</a></b>&nbsp;&nbsp;&nbsp;<br><br>
      <script>
        {
          var date = new Date();
          var m = date.getMonth();
          var d = date.getDate();
          if ( ((m == 11) && (d >= 15)) // after December 15th
               || ((m == 0) && (d <= 9)) ) { // before January 9th
            // (Display values will be updated below if necessary)
            document.write("<img id='img_1' style='display:none;' src='img/End_of_year.png'>&nbsp;<br><img id='img_2' style='display:none;' src='img/End_of_year2.png'>&nbsp;");
          }
        }
      </script>
    </p>

    <!-- Run main Super Master Mind javascript -->

    <script>
      let html_compatibility_game_version = "Ver_F7";
      let nb_errors_submitted = 0;
      let mobileMode = false;
      let androidMode = false;
      document.body.onkeydown = function(e) {
        if (String.fromCharCode(e.keyCode).toLowerCase() == 'l') {
          var mode = prompt("Which mode do you want to select?", "444");
          if (mode != null) {
            document.getElementById('form_list_id').value = mode.trim();
            setTimeout("submitForm();", 444);
          }
        }
      };
      // Set AJAX timeout to X seconds (this will set all AJAX requests the program makes, even via $.getJSON, to have a timeout of X seconds)
      $.ajaxSetup({
        timeout: 30*1000 // 30 seconds
      });
    </script>
    <script src='SuperMasterMind.js'></script>

    <!-- Handle player's info -->

    <script src='lib/tingle-master/dist/tingle.min.js'></script>
    <script>

      var modal_mode = -1;
      var store_time = new Date().getTime();

      var modal = new tingle.modal({
          footer: true,
          stickyFooter: false,
          closeMethods: ['overlay', 'button', 'escape'],
          // closeMethods: ['button'],
          closeLabel: "Close",
          cssClass: ['custom-class-1', 'custom-class-2'],
          onOpen: function() {
            console.log('(modal onOpen)');
          },
          onClose: function() {
            console.log('(modal onClose)');
          },
          beforeClose: function() {

            console.log('(modal beforeClose)');
            if (modal_mode == 1) {

              let place_error = false;
              let country_debug = "NA";
              let city_debug = "NA";

              // Get selected country name
              try {
                let elt = document.getElementById("country_selection");
                if ( (elt.selectedIndex != -1) && (elt.selectedIndex > 0) /* (skip very first option) */) {
                  if (typeof(Storage) !== 'undefined') {
                    localStorage.countryname = elt.options[elt.selectedIndex].text;
                  }
                  country_debug = elt.options[elt.selectedIndex].text;
                }
                else {
                  alert("No country was selected!\nYou shall select a country in order to store your game scores...");
                  place_error = true;
                  country_debug = "no country was selected";
                }
              }
              catch (exc) {
                console.log("error encountered at country name selection: " + exc);
              }

              // Get city name entered
              try {
                let city_entered = document.getElementById("city_input").value;
                city_entered = city_entered.trim();
                if ( (city_entered.length >= 3) && (city_entered.length <= 20) && (/^[A-zÀ-ÿ '-]+$/.test(city_entered)) /* (only letters) */ && isCorrect(city_entered) ) {
                  if (typeof(Storage) !== 'undefined') {
                    localStorage.cityname = capitalizeFirstLetters(city_entered);
                  }
                }
                else {
                  if (!place_error) {
                    alert("Invalid city name: " + city_entered + "\nYou shall enter a valid city name in order to store your game scores...");
                    place_error = true;
                  }
                }
                city_debug = city_entered;
              }
              catch (exc) {
                console.log("error encountered at city name selection: " + exc);
              }

              if (typeof(Storage) !== 'undefined') {

                localStorage.removeItem('automaticPositioning'); // localStorage.automaticPositioning

                if (localStorage.countryname && localStorage.cityname && (!place_error)) {
                  console.log("new countryname: " + localStorage.countryname);
                  document.getElementById('form_country_id').value = localStorage.countryname;
                  var region = getRegion(localStorage.countryname, localStorage.cityname);
                  console.log("new region: " + region);
                  document.getElementById('form_region_id').value = region;
                  console.log("new city: " + localStorage.cityname);
                  document.getElementById('form_city_id').value = localStorage.cityname;
                  if (localStorage.automaticPositioning) {
                    document.getElementById('form_geoloc_id').value = firstgamegeoloc + '-' + '~i';
                  }
                  else {
                    document.getElementById('form_geoloc_id').value = firstgamegeoloc + '-' + '~~i';
                  }
                  setTimeout("submitForm();", 444);
                }
                else {
                  // country and city names shall be consistent with each other
                  localStorage.removeItem('countryname'); // localStorage.countryname
                  localStorage.removeItem('cityname'); // localStorage.cityname

                  let errorStr = "";
                  if (typeof(Storage) !== 'undefined') {
                    if (localStorage.firstaccessid) {
                      errorStr = " for first access id " + localStorage.firstaccessid;
                    }
                    if (localStorage.gamesok) {
                      errorStr = errorStr + " after " + localStorage.gamesok + " game(s)";
                    }
                    if (localStorage.html_geoloc_already_done) {
                      errorStr = errorStr + " with HTML geolocation status " + localStorage.html_geoloc_already_done;
                    }
                  }
                  alert("If you accept to share your location,\nthis information will be used to store your score\nand you will also see the other players scores and rankings"); // (duplicated line)
                  submitForm("warning: invalid place information entered (" + country_debug + ", " + city_debug + ")" + errorStr, true);
                }
                attempt_HTML_geolocation(true); // Subject to user acceptance => may complete / correct (in an automated way) above user inputs

              }

              modal_mode = -1;
              return true; // close the modal
              // return false; // nothing happens

            }

            else if (modal_mode == 2) {

              // Get firstname entered
              try {
                let firstname_entered = document.getElementById("firstname_input").value;
                firstname_entered = firstname_entered.trim();
                if ( (firstname_entered.length >= 3) && (firstname_entered.length <= 12) && (/^[A-zÀ-ÿ'-]+$/.test(firstname_entered)) /* (only letters) */ && isCorrect(firstname_entered) ) {
                  if (typeof(Storage) !== 'undefined') {
                    localStorage.firstname = capitalizeFirstLetters(firstname_entered);
                  }
                }
                else {
                  alert("Invalid first name: " + firstname_entered);
                }
              }
              catch (exc) {
                console.log("error encountered at first name selection: " + exc);
              }

              if (typeof(Storage) !== 'undefined') {
                if (!localStorage.firstnameAsked) {
                  localStorage.firstnameAsked = 0;
                }
                localStorage.firstnameAsked = Number(localStorage.firstnameAsked) + 1;
                if (localStorage.firstname) {
                  console.log("new firstname: " + localStorage.firstname);
                  document.getElementById('form_firstname_id').value = localStorage.firstname;
                }
              }
              setTimeout("submitForm();", 444);

              modal_mode = -1;
              return true; // close the modal

            }

            else if (modal_mode == 3) {

              setTimeout("showPossibleCodesButtonClick(false, -1, true);", 444);
              // (same effect: setTimeout("document.getElementById('showPossibleCodesButton').click();", 444);)

              modal_mode = -1;
              return true; // close the modal
            }

            modal_mode = -1;
            return true; // close the modal
            // return false; // nothing happens

          }
      });
      // add a button
      modal.addFooterBtn('OK', 'tingle-btn tingle-btn--primary', function() {
        // here goes some logic
        modal.close();
      });

    </script>

    <iframe style='display:none;' name='my_frame'>Your browser does not support iframes!</iframe> <!-- suppress style='display:none;' to see the form's response -->
    <form  style='display:none;' id='my_form' target='my_frame' action='https://script.google.com/macros/s/AKfycbwHJh1Tz7idd8VQJNdWIqWd-6jMxInhRtqY_O96NN7OvEKiY_ox/exec'>

      playerid: <input id='form_playerid_id' name='playerid' type='text' value='-'><br>
      firstname: <input id='form_firstname_id' name='firstname' type='text' value='-'><br>

      nbcolumns: <input id='form_nbcolumns_id' name='nbcolumns' type='text' value='-'><br>
      score: <input id='form_score_id' name='score' type='text' value='-'><br>
      attempts: <input id='form_attempts_id' name='attempts' type='text' value='-'><br>
      time: <input id='form_time_id' name='time' type='text' value='-'><br>
      perfs: <input id='form_perfs_id' name='perfs' type='text' value='-'><br>
      nbuknperfs: <input id='form_nbuknperfs_id' name='nbuknperfs' type='text' value='-'><br>
      help: <input id='form_help_id' name='help' type='text' value='-'><br>

      gamesok: <input id='form_gamesok_id' name='gamesok' type='text' value='-'><br>
      deltagames: <input id='form_deltagames_id' name='deltagames' type='text' value='-'><br>

      country: <input id='form_country_id' name='country' type='text' value='-'><br>
      region: <input id='form_region_id' name='region' type='text' value='-'><br>
      zip: <input id='form_zip_id' name='zip' type='text' value='-'><br>
      city: <input id='form_city_id' name='city' type='text' value='-'><br>
      geoloc: <input id='form_geoloc_id' name='geoloc' type='text' value='-'><br>
      timezone: <input id='form_timezone_id' name='timezone' type='text' value='-'><br>
      latitude: <input id='form_latitude_id' name='latitude' type='text' value='-'><br>
      longitude: <input id='form_longitude_id' name='longitude' type='text' value='-'><br>
      ipaddress: <input id='form_ipaddress_id' name='ipaddress' type='text' value='-'><br>

      platform: <input id='form_platform_id' name='platform' type='text' value='-'><br> <!-- OS -->
      browserlanguage: <input id='form_browserlanguage_id' name='browserlanguage' type='text' value='-'><br> <!-- Browser language -->
      useragent: <input id='form_useragent_id' name='useragent' type='text' value='-'><br> <!-- Browser (more or less) -->
      href: <input id='form_href_id' name='href' type='text' value='-'><br>
      formsubmitdate: <input id='form_formsubmitdate_id' name='formsubmitdate' type='text' value='-'><br>
      debuginfo: <input id='form_debuginfo_id' name='debuginfo' type='text' value='-'><br>

      list: <input id='form_list_id' name='list' type='text' value='-'><br>

      rankings: <input id='form_rankings_id' name='rankings' type='text' value='-'><br>

    </form>

    <script>

      function sleep(ms) { // To be called like "await sleep(1000);"
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      function capitalizeFirstLetters(str) {
        if (str.length == 0) {
          return "";
        }
        else if (str.length == 1) {
          return str.charAt(0).toUpperCase();
        }
        else {
          let res = str.toLowerCase();
          res = res.charAt(0).toUpperCase() + res.slice(1);

          let res2 = "";
          let index = res.indexOf('-');
          while ((index != -1) && (index+1 < res.length)) {
            res2 = res2 + res.substring(0, index+1) + res.charAt(index+1).toUpperCase();
            if (index+2 < res.length) {
              res = res.slice(index+2);
              index = res.indexOf('-');
            }
            else {
              res = "";
              index = -1;
            }
          }
          res2 = res2 + res;
          res = res2;
          res2 = "";
          index = res.indexOf(' ');
          while ((index != -1) && (index+1 < res.length)) {
            res2 = res2 + res.substring(0, index+1) + res.charAt(index+1).toUpperCase();
            if (index+2 < res.length) {
              res = res.slice(index+2);
              index = res.indexOf(' ');
            }
            else {
              res = "";
              index = -1;
            }
          }
          res2 = res2 + res;

          res = res2;
          res2 = "";
          index = res.indexOf("'");
          while ((index != -1) && (index+1 < res.length)) {
            res2 = res2 + res.substring(0, index+1) + res.charAt(index+1).toUpperCase();
            if (index+2 < res.length) {
              res = res.slice(index+2);
              index = res.indexOf("'");
            }
            else {
              res = "";
              index = -1;
            }
          }
          res2 = res2 + res;

          res2 = res2.replace(" D'"," d'");
          res2 = res2.replace(" Sur "," sur ");

          return res2;
        }
      }

      function getLocation() {
        switch(location.protocol) {
           case 'http:':
             return 'P1';
           case 'https:':
             return 'P1b';
           case 'file:':
             return 'P2';
           default:
             // (other protocols)
             return 'P3';
        }
      }

      function isCorrect(str) {
        if ( (str.toLowerCase().indexOf('bastard') != -1)
             || (str.toLowerCase().indexOf('fuck') != -1)
             || (str.toLowerCase().indexOf('xxx') != -1)
             || (str.toLowerCase().indexOf('noname') != -1)
             || (str.toLowerCase().indexOf('myname') != -1)
             || (str.toLowerCase().indexOf('nobody') != -1)
             || (str.toLowerCase().indexOf('noone') != -1)
             || (str.toLowerCase().indexOf('dummy') != -1)
             || (str.toLowerCase().indexOf('empty') != -1) ) {
          return false;
        }
        return true;
      }
      if (typeof(Storage) !== 'undefined') {
        if (localStorage.firstname && (!isCorrect(localStorage.firstname))) {
          localStorage.previousfirstname = localStorage.firstname;
          localStorage.removeItem('firstname'); // localStorage.firstname
        }
      }

      function getRegion(country, city) {
        // Manual region setting
        if ((country == "France") && (city == "Paris")) { // Particular case #1
          return 'Île-de-France';
        }
        else if ((country == "Germany") && (city == "Dortmund")) { // Particular case #2
          return 'Nordrhein-Westfalen';
        }
        else {
          return '-';
        }
      }

      function HTML_geolocation_success(position) {
        let latitude = position.coords.latitude;
        let longitude = position.coords.longitude;
        console.log("HTML geolocation:");
        console.log(" latitude: " + latitude);
        console.log(" longitude: " + longitude);
        let GEOCODING = 'https://maps.googleapis.com/maps/api/geocode/json?latlng=' + latitude + '%2C' + longitude + '&language=en&key=AIzaSyBhO3CSP-LxypDUjC-MYa_b8iPfJ9qJBko';
        $.getJSON(GEOCODING).done(function(location) {
          try {
            if (location.status.toUpperCase() == "OK") {
              let country = String(location.results[0].address_components[5].long_name).trim();
              let region = String(location.results[0].address_components[4].long_name).trim();
              let city = String(location.results[0].address_components[2].long_name).trim();
              console.log(location);
              console.log(" country: " + country);
              console.log(" region: " + region);
              console.log(" city: " + city);
              console.log(" address: " + location.results[0].formatted_address);
              if ((country.length >= 3) && (city.length >= 3)) { // (redundant lines)
                localStorage.countryname = country;
                if (region.length >= 2) { // (redundant lines)
                  localStorage.regionname = region;
                }
                else {
                  localStorage.regionname = '-';
                }
                localStorage.cityname = city;
                localStorage.automaticPositioning = true;
                localStorage.html_geoloc_already_done = "ok";
              }
              else {
                console.log("HTML geolocation error: invalid location values");
                localStorage.html_geoloc_already_done = "nok-1";
              }
            }
            else {
              console.log("HTML geolocation error: status: " + location.status);
              localStorage.html_geoloc_already_done = "nok-2/" + location.status;
            }
          }
          catch (exc) {
            console.log("HTML geolocation error: " + exc);
            localStorage.html_geoloc_already_done = "nok-3/" + exc;
          }
        })
        .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
          console.log(("HTML geolocation failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
          localStorage.html_geoloc_already_done = "nok-4";
        });
      }
      function HTML_geolocation_error(error) {
        let error_str = "?";
        switch(error.code) {
          case error.PERMISSION_DENIED:
            if (!localStorage.html_geoloc_denied) {
              localStorage.html_geoloc_denied = 0;
            }
            localStorage.html_geoloc_denied = Number(localStorage.html_geoloc_denied) + 1;
            error_str = "user denied the request for geolocation/" + localStorage.html_geoloc_denied + "x";
            break;
          case error.POSITION_UNAVAILABLE:
            error_str = "location information is unavailable";
            break;
          case error.TIMEOUT:
            error_str = "the request to get user location timed out";
            break;
          case error.UNKNOWN_ERROR:
            error_str = "an unknown error occurred";
            break;
        }
        console.log("HTML geolocation error: " + error_str);
        localStorage.html_geoloc_already_done = "nok-5/" + error_str;
      }
      let attempt_HTML_geolocation_already_done = false;
      function attempt_HTML_geolocation(forced_mode) {
        if ((!forced_mode) && attempt_HTML_geolocation_already_done) {
          console.log("attempt_HTML_geolocation: skipped");
          return;
        }
        attempt_HTML_geolocation_already_done = true;
        if (typeof(Storage) !== 'undefined') {
          if (navigator.geolocation) {
            // Subject to user acceptance
            navigator.geolocation.getCurrentPosition(HTML_geolocation_success, HTML_geolocation_error);
          }
          else {
            console.log("HTML geolocation error: geolocation is not supported by the browser");
            localStorage.html_geoloc_already_done = "nok-6";
          }
        }
      }

      function str_from_jqxhr(jqxhr) { // (jqxhr: XMLHTTPRequest)
        try {
          let str = "jqxhr={";
          try {
            /* Status:
               200: "OK"
               403: "Forbidden"
               404: "Page not found"
               ... */
            str = str + "status:" + jqxhr.status;
            str = str + ",statusText:" + jqxhr.statusText;
            /* readyState holds the status of the XMLHttpRequest:
               0: request not initialized
               1: server connection established
               2: request received
               3: processing request
               4: request finished and response is ready */
            str = str + ",readyState:" + jqxhr.readyState;
          }
          catch (exc) {
            str = str + "?";
          }
          str = str + "}";
          return str;
        }
        catch (exc) {
          return "jqxhr=?";
        }
      }

      // Interesting links about JSONP:
      // - https://en.wikipedia.org/wiki/Same-origin_policy and https://www.getfilecloud.com/blog/using-jsonp-for-cross-domain-requests/ (JSONP usage & safety)
      // - https://ctrlq.org/code/20197-jquery-ajax-call-google-script (usage of JSONP to avoid "Cross Origin" issues)
      //   => "JSONP" to be replaced by "CORS" in the future when fully supported, which is safer.
      function submitForm(formStr = "", skipErrorDisplay = false, retryTime = 3333) {

        let my_form_url = document.getElementById("my_form").action + '?';
        if (formStr == "") { // Nominal case
          // console.log(JSON.stringify($("#my_form").serializeArray()));
          let elements = document.getElementById("my_form").elements;
          for (let i = 0, element; element = elements[i++];) {
            my_form_url = my_form_url + element.name + '=' + element.value + '&';
          }
        }
        else { // Specific case
          my_form_url = my_form_url + 'form_str=' + formStr + '&';
        }
        my_form_url = my_form_url + 'k=' + Math.floor(Math.random()*9999999999+1) + '&';
        my_form_url = my_form_url + 'my_callback_fct=handle_rsp';
        // console.log(my_form_url);
        // Submit form
        console.log("(jQuery.ajax get/jsonp" + ((formStr == "") ? "" : " for a specific case") + ")");
        jQuery.ajax({
          crossDomain: true,
          url: my_form_url,
          method: "GET",
          dataType: "jsonp"
        })
        .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)

          try {
            if (jqxhr.status == 404) { // Corresponds to the error "Loading failed for the <script> with source https://..."
              console.log(("script submission failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
              // Keep some time between the 2 form submissions
              let now = new Date().getTime();
              while(new Date().getTime() < now + retryTime){}; // (interface is frozen during this short time)

              jQuery.ajax({
                crossDomain: true,
                url: my_form_url,
                method: "GET",
                dataType: "jsonp"
              })
              .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
                try {
                  if (jqxhr.status == 404) { // Corresponds to the error "Loading failed for the <script> with source https://..."
                    console.log(("script submission retry failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
                  } // else: systematic parse error is ignored
                  if ((formStr == "") && (!skipErrorDisplay)) {
                    alert("Oops... a network error occurred, game scores could not be displayed");
                  }
                }
                catch (exc) {
                  console.log(("script submission retry failure (abnormal case): " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
                }
              });
            } // else: systematic parse error is ignored
          }
          catch (exc) {
            console.log(("script submission failure (abnormal case): " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
          }

        });

        // document.getElementById('my_form').submit();
        // $("#my_form").submit();
      }

      var playerid_prefix = "ID/";
      function handle_rsp_delayed(e) {
        if ( (e !== undefined)
             && (typeof e.parameter !== 'undefined')
             && (typeof e.parameter.playerid !== 'undefined')
             && (typeof e.rsp_cd == 'undefined')
             && (typeof e.parameter.rankings !== 'undefined') && (e.parameter.rankings.length > 10) ) {
          var rsp_rankings_str = JSON.stringify(e.parameter.rankings).replaceAll("^\"|\"$", ""); // (suppress leading and ending double quotes)
          console.log("1: " + rsp_rankings_str);
          rsp_rankings_str = rsp_rankings_str.replaceAll("<td>", "<td style='border:1px solid black;margin:2px;padding:2px;text-align:center;font-weight:bold;'>"); // <td>'s style is applied
          console.log("2: " + rsp_rankings_str);
          // Rk: top scores are always displayed, even if current game score is not in them
          if (modal_mode == -1) {
            modal_mode = 3;
            // set modal content
            modal.setContent("<div style='-webkit-touch-callout: none; /* iOS Safari */ -webkit-user-select: none; /* Safari */ -khtml-user-select: none; /* Konqueror HTML */ -moz-user-select: none; /* Firefox */ -ms-user-select: none; /* Internet Explorer/Edge */ user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */'>"
                             + rsp_rankings_str
                             + "</div>");
            // open modal
            modal.open();
          }
          else {
            console.log("modal display conditions not fulfilled (" + modal_mode + ")");
          }
        }
        else {
          if (e == undefined) {
            console.log('rsp_cd: ?');
          }
          else if (typeof e.rsp_cd !== 'undefined') {
            console.log('rsp_cd: ' + JSON.stringify(e.rsp_cd));
          }
          else {
            console.log('rsp_cd: ?');
          }
        }
      }
      function handle_rsp(e) {
        console.log("(handle_rsp)");

        var score_display_time = 4444; // (see blinking time)
        if (mobileMode) {
          score_display_time = 1444; // (no blinking)
        }

        var time_to_wait = 44;
        var time_diff = new Date().getTime() - store_time;
        if (time_diff < 0) { // (invalid case)
          time_to_wait = 44;
        }
        else if (time_diff < score_display_time) {
          time_to_wait = score_display_time - time_diff;
        }
        else {
          time_to_wait = 44; // (no time to wait, form submission was long enough)
        }
        console.log("(time_diff=" + time_diff + ", time_to_wait=" + time_to_wait + ")");
        setTimeout("handle_rsp_delayed(" + JSON.stringify(e) + ");", time_to_wait);
      }

      var last_data_used = null;
      var last_game_cnt = -1;
      async function store_player_info(game_cnt, nbcolumns, score, attempts, timestr, perfs, nbuknperfs, help) { // asynchronous function

        try {

          if (game_cnt == last_game_cnt) { // At most one storage per game
            return;
          }
          last_game_cnt = game_cnt;
          store_time = new Date().getTime();

          let gamesok = -1;
          let deltagames = -1;
          if (typeof(Storage) !== 'undefined') {

            if (!localStorage.gamesok) {
              localStorage.gamesok = 0;
            }
            localStorage.gamesok = Number(localStorage.gamesok) + 1;
            gamesok = Number(localStorage.gamesok);

            switch (nbcolumns) {

              case 3:
                if (!localStorage.nbgamesstarted3) {
                  localStorage.nbgamesstarted3 = 0;
                }
                if (!localStorage.nbgamesstarted3_ref) {
                  localStorage.nbgamesstarted3_ref = 0;
                }
                deltagames = localStorage.nbgamesstarted3 - localStorage.nbgamesstarted3_ref - 1;
                localStorage.nbgamesstarted3_ref = localStorage.nbgamesstarted3;
                break;
              case 4:
                if (!localStorage.nbgamesstarted4) {
                  localStorage.nbgamesstarted4 = 0;
                }
                if (!localStorage.nbgamesstarted4_ref) {
                  localStorage.nbgamesstarted4_ref = 0;
                }
                deltagames = localStorage.nbgamesstarted4 - localStorage.nbgamesstarted4_ref - 1;
                localStorage.nbgamesstarted4_ref = localStorage.nbgamesstarted4;
                break;
              case 5:
                if (!localStorage.nbgamesstarted5) {
                  localStorage.nbgamesstarted5 = 0;
                }
                if (!localStorage.nbgamesstarted5_ref) {
                  localStorage.nbgamesstarted5_ref = 0;
                }
                deltagames = localStorage.nbgamesstarted5 - localStorage.nbgamesstarted5_ref - 1;
                localStorage.nbgamesstarted5_ref = localStorage.nbgamesstarted5;
                break;
              case 6:
                if (!localStorage.nbgamesstarted6) {
                  localStorage.nbgamesstarted6 = 0;
                }
                if (!localStorage.nbgamesstarted6_ref) {
                  localStorage.nbgamesstarted6_ref = 0;
                }
                deltagames = localStorage.nbgamesstarted6 - localStorage.nbgamesstarted6_ref - 1;
                localStorage.nbgamesstarted6_ref = localStorage.nbgamesstarted6;
                break;

              case 7:
                if (!localStorage.nbgamesstarted7) {
                  localStorage.nbgamesstarted7 = 0;
                }
                if (!localStorage.nbgamesstarted7_ref) {
                  localStorage.nbgamesstarted7_ref = 0;
                }
                deltagames = localStorage.nbgamesstarted7 - localStorage.nbgamesstarted7_ref - 1;
                localStorage.nbgamesstarted7_ref = localStorage.nbgamesstarted7;
                break;

              default:
                console.log("Error: invalid nbcolumns in store_player_info(): " + nbcolumns);
                return;

            }

          }

          var geolocation_handler = {

            run_retry: function (data_p) {
              /* ipinfodb.com response format:
                 - SUCCESS case:
                  statusCode	"OK"
                  statusMessage	""
                  ipAddress	"94.239.111.222"
                  countryCode	"FR"
                  countryName	"France"
                  regionName	"Ile-de-France"
                  cityName	"Paris"
                  zipCode	"75000"
                  latitude	"48.8534"
                  longitude	"2.3488"
                  timeZone	"+01:00"
                - FAILURE case:
                  statusCode	"ERROR"
                  statusMessage	"Invalid IP Address."
                  ipAddress	"994.239.111.222"
                  countryCode	""
                  countryName	""
                  regionName	""
                  cityName	""
                  zipCode	""
                  latitude	"0"
                  longitude	"0"
                  timeZone	""
              */
              let converted_data = JSON.stringify(data_p);

              console.log("(geolocation retry data conversion for " + converted_data + ")");

              if ((typeof data_p.statusCode != 'undefined') && (typeof data_p.statusMessage != 'undefined') && (data_p.statusCode != "OK")) {
                console.log("geolocation error in run_retry(): " + data_p.statusCode + " " + data_p.statusMessage);
              }

              // latitude -> latitude
              // longitude -> longitude
              // countryName -> country_name
              converted_data = converted_data.replace("countryName", "country_name");
              // regionName -> region
              converted_data = converted_data.replace("regionName", "region");
              // zipCode -> postal
              converted_data = converted_data.replace("zipCode", "postal");
              // cityName -> city
              converted_data = converted_data.replace("cityName", "city");
              // timeZone -> time_zone
              converted_data = converted_data.replace("timeZone", "time_zone");
              // ipAddress -> ip
              converted_data = converted_data.replace("ipAddress", "ip");

              geolocation_handler.run(JSON.parse(converted_data), true);
            },

            nb_JSON_queries_posted: 0,
            first_geolocation_errorStr: "-",

            run: function (data_p) {

              // Check that the response contains valid information
              // **************************************************

              let this_data_is_valid = false;
              if ( (typeof data_p.latitude != 'undefined') && (typeof data_p.longitude != 'undefined') // (redundant lines)
                   && ((String(data_p.latitude).indexOf('.') != -1) || (String(data_p.longitude).indexOf('.') != -1)) // (redundant lines)
                   && ((typeof data_p.country_name != 'undefined') && (data_p.country_name.length >= 3)) // (redundant lines)
                   && ((typeof data_p.city != 'undefined') && (data_p.city.length >= 3)) // (redundant lines)
                   && ((typeof data_p.ip != 'undefined') && (String(data_p.ip).trim().length >= 7 /* 0.0.0.0 */)) ) { // (redundant lines)
                this_data_is_valid = true;
                if (typeof(Storage) !== 'undefined') { // Better than manual positioning (and will be updated if necessary)
                  localStorage.countryname = String(data_p.country_name).trim();
                  if ((typeof data_p.region != 'undefined') && (data_p.region.length >= 2)) { // (redundant lines)
                    localStorage.regionname = String(data_p.region).trim();
                  }
                  else {
                    localStorage.regionname = '-';
                  }
                  localStorage.cityname = String(data_p.city).trim();
                  localStorage.automaticPositioning = true;
                }
              }
              let last_data_used_is_valid = false;
              if ( (last_data_used != null)
                   && (typeof last_data_used.latitude != 'undefined') && (typeof last_data_used.longitude != 'undefined') // (redundant lines)
                   && ((String(last_data_used.latitude).indexOf('.') != -1) || (String(last_data_used.longitude).indexOf('.') != -1)) // (redundant lines)
                   && ((typeof last_data_used.country_name != 'undefined') && (last_data_used.country_name.length >= 3)) // (redundant lines)
                   && ((typeof last_data_used.city != 'undefined') && (last_data_used.city.length >= 3)) // (redundant lines)
                   && ((typeof last_data_used.ip != 'undefined') && (String(last_data_used.ip).trim().length >= 7 /* 0.0.0.0 */)) ) { // (redundant lines)
                last_data_used_is_valid = true;
              }
              let successcase__this_data_is_used;
              let data;
              let last_data_tag = "";
              if (this_data_is_valid || (!last_data_used_is_valid)) {
                data = data_p;
              }
              else { // Reuse last valid geolocation data
                data = last_data_used;
                last_data_tag = "r";
              }
              successcase__this_data_is_used = (data != last_data_used); // (data_p and last_data_used may be equal pointers)
              console.log("(geolocation: this_data:" + this_data_is_valid + ", last_data_used:" + last_data_used_is_valid + ", this_data_is_used: " + successcase__this_data_is_used + ")");
              last_data_used = data;

              let country = '-';
              let region = '-';
              let zip = '-';
              let city = '-'; // (city may stay equal to this default value if not valid)
              let geoloc = '-';  // (geoloc may stay equal to this default value if not valid)
              let timezone = '-';
              let latitude = '-';
              let longitude = '-';
              let ipaddress = '-'; // (ipaddress may stay equal to this default value if not valid)
              if ( (typeof data.latitude != 'undefined') && (typeof data.longitude != 'undefined') // (redundant lines)
                   && ((String(data.latitude).indexOf('.') != -1) || (String(data.longitude).indexOf('.') != -1)) ) {

                if ((typeof data.country_name != 'undefined') && (String(data.country_name).trim().length >= 3)) { // (redundant lines)
                  country = String(data.country_name).trim();
                }
                else {
                  console.log('invalid country name in response');
                }
                if ((typeof data.region != 'undefined') && (String(data.region).trim().length >= 2)) {
                  region = String(data.region).trim();
                }
                else {
                  console.log('invalid region name in response');
                }
                if ((typeof data.postal != 'undefined') && (String(data.postal).trim().length >= 2)) {
                  zip = String(data.postal).trim();
                }
                else {
                  console.log('invalid zip code in response');
                }
                if ((typeof data.city != 'undefined') && (String(data.city).trim().length >= 3)) { // (redundant lines)
                  city = String(data.city).trim();
                  geoloc = 'ok' + String(geolocation_handler.nb_JSON_queries_posted) + last_data_tag;
                }
                else {
                  console.log('invalid city name in response');
                }
                if ((typeof data.time_zone != 'undefined') && (String(data.time_zone).trim().length >= 2)) {
                  if ((typeof data.time_zone.name != 'undefined') && (String(data.time_zone.name).trim().length >= 2)) {
                    timezone = String(data.time_zone.name).trim();
                  }
                  else {
                    timezone = String(data.time_zone).trim();
                  }
                }
                else {
                  console.log('invalid time zone in response');
                }
                if (typeof data.latitude != 'undefined') {
                  latitude = String(data.latitude).trim();
                }
                else {
                  console.log('invalid latitude response');
                }
                if (typeof data.longitude != 'undefined') {
                  longitude = String(data.longitude).trim();
                }
                else {
                  console.log('invalid longitude in response');
                }

              }

              let valid_ipaddress = false;
              if ((typeof data.ip != 'undefined') && (String(data.ip).trim().length >= 7 /* 0.0.0.0 */)) { // (redundant lines)
                ipaddress = String(data.ip).trim();
                valid_ipaddress = true;
              }
              else {
                console.log('invalid ip address in response');
              }

              // Manual geolocation table corrections for particular IP addresses
              if ( (ipaddress.indexOf("176.130.42.") == 0) && (ipaddress.length <= 15) ) { // 176.130.42.* IPv4 addresses
                country = "France";
                region = "Alsace";
                city = "Munster";
                geoloc = 'ok' + String(geolocation_handler.nb_JSON_queries_posted) + last_data_tag + "+";
              }

              // Manual conversions
              if (localStorage.firstname && (localStorage.firstname.indexOf("Ghi") == 0) && (region == "Illinois") && (city == "Naperville")) {
                country = "France";
                region = "Île-de-France";
                city = "Paris";
                geoloc = 'ok' + String(geolocation_handler.nb_JSON_queries_posted) + last_data_tag + "+";
              }
              else if (localStorage.firstname && (localStorage.firstname.indexOf("Ghi") == 0) && (region == "California") && (city == "San Jose")) {
                country = "France";
                region = "Île-de-France";
                city = "Paris";
                geoloc = 'ok' + String(geolocation_handler.nb_JSON_queries_posted) + last_data_tag + "+";
              }
              if (region == "North Rhine-Westphalia") {
                region = "Nordrhein-Westfalen";
              }
              if (country == "Lao People's Democratic Republic") {
                country = "Laos";
              }
              if ((country == "Portugal") && (region == "Regiao Autonoma da Madeira")) {
                region = "Madeira";
              }

              // Check if geolocation data are valid
              if (geolocation_handler.nb_JSON_queries_posted == 1) {
                if ((!valid_ipaddress) || (city == '-')) {
                  let retry_error_str = "";
                  if (!valid_ipaddress) {
                    retry_error_str += "invalid IP address ";
                    if (typeof data.ip != 'undefined') {
                      retry_error_str += String(data.ip).trim() + " ";
                    }
                  }
                  if (city == '-') {
                    retry_error_str += "invalid city ";
                    if (typeof data.city != 'undefined') {
                      retry_error_str += String(data.city).trim();
                    }
                  }
                  // => exit the function and retry
                  return geolocation_handler.geolocation_retry("", "manual geolocation retry due to invalid geolocation data", retry_error_str.trim());
                }
              }

              if (typeof(Storage) !== 'undefined') {
                if ( (country == '-') || (city == '-') ) { // Fill a consistent set of {country, region, city} values
                  if (localStorage.countryname && localStorage.cityname) {
                    country = localStorage.countryname;
                    if (localStorage.automaticPositioning && localStorage.regionname) {
                      region = localStorage.regionname;
                    }
                    else {
                      region = getRegion(localStorage.countryname, localStorage.cityname);
                    }
                    city = localStorage.cityname;
                    if (localStorage.automaticPositioning) {
                      geoloc = '~' + String(geolocation_handler.nb_JSON_queries_posted);
                    }
                    else {
                      geoloc = '~~' + String(geolocation_handler.nb_JSON_queries_posted);
                    }
                  }
                }
                geoloc = firstgamegeoloc + '-' + geoloc;
              }

              console.log(country);
              document.getElementById('form_country_id').value = country;
              console.log(region);
              document.getElementById('form_region_id').value = region;
              console.log(zip);
              document.getElementById('form_zip_id').value = zip;
              console.log(city);
              document.getElementById('form_city_id').value = city;
              console.log(geoloc);
              document.getElementById('form_geoloc_id').value = geoloc;
              console.log(timezone);
              document.getElementById('form_timezone_id').value = timezone;
              console.log(latitude);
              document.getElementById('form_latitude_id').value = latitude;
              console.log(longitude);
              document.getElementById('form_longitude_id').value = longitude;
              console.log(ipaddress);
              document.getElementById('form_ipaddress_id').value = ipaddress;

              // Other fields
              // ************

              let playerid;
              let firstname = "-"; // (firstname may stay equal to this default value if not defined)
              if (typeof(Storage) !== 'undefined') {
                if (localStorage.firstname) {
                  firstname = localStorage.firstname;
                }
                if (!localStorage.playerid) {
                  let id = makeid() + ' - ' + new Date();
                  localStorage.playerid = id;
                }
                playerid = playerid_prefix + localStorage.playerid;
              }
              else {
                console.log("Error: your browser does not support web storage...");
                playerid = playerid_prefix + "Default";
              }

              console.log(playerid);
              document.getElementById('form_playerid_id').value = playerid;
              console.log(firstname);
              document.getElementById('form_firstname_id').value = firstname;
              console.log(nbcolumns);
              document.getElementById('form_nbcolumns_id').value = nbcolumns;
              console.log(score);
              document.getElementById('form_score_id').value = score;
              console.log(attempts);
              document.getElementById('form_attempts_id').value = attempts;
              console.log(timestr);
              document.getElementById('form_time_id').value = timestr;
              console.log(perfs);
              document.getElementById('form_perfs_id').value = perfs;
              console.log(nbuknperfs);
              document.getElementById('form_nbuknperfs_id').value = nbuknperfs;
              console.log(help);
              document.getElementById('form_help_id').value = help;
              console.log(gamesok);
              document.getElementById('form_gamesok_id').value = gamesok;
              console.log(deltagames);
              document.getElementById('form_deltagames_id').value = deltagames;

              console.log(navigator.platform);
              document.getElementById('form_platform_id').value = navigator.platform;
              console.log(navigator.language);
              document.getElementById('form_browserlanguage_id').value = navigator.language;
              console.log(navigator.userAgent);
              document.getElementById('form_useragent_id').value = navigator.userAgent;
              document.getElementById('form_href_id').value = decodeURI(location.href);
              document.getElementById('form_formsubmitdate_id').value = new Date();

              var extra_debug_info = "";
              try {
                extra_debug_info = "/Cookies:" + navigator.cookieEnabled;
                extra_debug_info = extra_debug_info + "/Java:" + navigator.javaEnabled();
                var pluginsLength = navigator.plugins.length; // (Note: plugin listing is no longer allowed in Firefox for security reasons => length will be less than the actual value)
                extra_debug_info =  extra_debug_info + "/Plugins:" + pluginsLength;
                if (pluginsLength > 0) {
                  for (var i = 0; i < pluginsLength; i++) {
                    extra_debug_info = extra_debug_info + "|" + i + ":" + navigator.plugins[i].filename + (navigator.plugins[i].version ? navigator.plugins[i].version : "");
                  }
                }
                extra_debug_info = extra_debug_info + "/MimeTypes:" + navigator.mimeTypes.length;
              }
              catch (exc) {}
              var firstNameAskedStr = "0x";
              var firstAccessIdStr = "-";
              if (typeof(Storage) !== 'undefined') {
                if (localStorage.firstnameAsked) {
                  firstNameAskedStr = localStorage.firstnameAsked + "x"; // (past game counter to simplify)
                }
                if (localStorage.firstaccessid) {
                  firstAccessIdStr = localStorage.firstaccessid;
                }
              }
              document.getElementById('form_debuginfo_id').value = getLocation() + '/Screen:' + screen.width + '*' + screen.height + ',' + screen.colorDepth + '/Inner:' + window.innerWidth + "*" + window.innerHeight + '/' + html_compatibility_game_version + '/GeolocStatus:' + successcase__this_data_is_used + '/FirstNameAsked:' + firstNameAskedStr + '/FirstAccessId:' + firstAccessIdStr + extra_debug_info;

              document.getElementById('form_rankings_id').value = '-';
              document.getElementById('form_list_id').value = '-';

              var form_to_be_submitted = true;
              if (typeof(Storage) !== 'undefined') {
                if ( ((city == '-') && (!localStorage.cityname))
                     || ((country == '-') && (!localStorage.countryname)) ) {
                  if (modal_mode == -1) {
                    modal_mode = 1;
                    // set modal content
                    modal.setContent("<div style='-webkit-touch-callout: none; /* iOS Safari */ -webkit-user-select: none; /* Safari */ -khtml-user-select: none; /* Konqueror HTML */ -moz-user-select: none; /* Firefox */ -ms-user-select: none; /* Internet Explorer/Edge */ user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */'>"
                                     + "<h2>Storing your scores...<br>Please enter your country and city names, they will be used to store your scores:</h2>"
                                     + "<h3>Your country:</h3><select id='country_selection'><option value=\"-\">Select your country...</option><option value=\"AF\">Afghanistan</option><option value=\"AX\">Åland Islands</option><option value=\"AL\">Albania</option><option value=\"DZ\">Algeria</option><option value=\"AS\">American Samoa</option><option value=\"AD\">Andorra</option><option value=\"AO\">Angola</option><option value=\"AI\">Anguilla</option><option value=\"AQ\">Antarctica</option><option value=\"AG\">Antigua and Barbuda</option><option value=\"AR\">Argentina</option><option value=\"AM\">Armenia</option><option value=\"AW\">Aruba</option><option value=\"AU\">Australia</option><option value=\"AT\">Austria</option><option value=\"AZ\">Azerbaijan</option><option value=\"BS\">Bahamas</option><option value=\"BH\">Bahrain</option><option value=\"BD\">Bangladesh</option><option value=\"BB\">Barbados</option><option value=\"BY\">Belarus</option><option value=\"BE\">Belgium</option><option value=\"BZ\">Belize</option><option value=\"BJ\">Benin</option><option value=\"BM\">Bermuda</option><option value=\"BT\">Bhutan</option><option value=\"BO\">Bolivia, Plurinational State of</option><option value=\"BQ\">Bonaire, Sint Eustatius and Saba</option><option value=\"BA\">Bosnia and Herzegovina</option><option value=\"BW\">Botswana</option><option value=\"BV\">Bouvet Island</option><option value=\"BR\">Brazil</option><option value=\"IO\">British Indian Ocean Territory</option><option value=\"BN\">Brunei Darussalam</option><option value=\"BG\">Bulgaria</option><option value=\"BF\">Burkina Faso</option><option value=\"BI\">Burundi</option><option value=\"KH\">Cambodia</option><option value=\"CM\">Cameroon</option><option value=\"CA\">Canada</option><option value=\"CV\">Cape Verde</option><option value=\"KY\">Cayman Islands</option><option value=\"CF\">Central African Republic</option><option value=\"TD\">Chad</option><option value=\"CL\">Chile</option><option value=\"CN\">China</option><option value=\"CX\">Christmas Island</option><option value=\"CC\">Cocos (Keeling) Islands</option><option value=\"CO\">Colombia</option><option value=\"KM\">Comoros</option><option value=\"CG\">Congo</option><option value=\"CD\">Congo, the Democratic Republic of the</option><option value=\"CK\">Cook Islands</option><option value=\"CR\">Costa Rica</option><option value=\"CI\">Côte d'Ivoire</option><option value=\"HR\">Croatia</option><option value=\"CU\">Cuba</option><option value=\"CW\">Curaçao</option><option value=\"CY\">Cyprus</option><option value=\"CZ\">Czech Republic</option><option value=\"DK\">Denmark</option><option value=\"DJ\">Djibouti</option><option value=\"DM\">Dominica</option><option value=\"DO\">Dominican Republic</option><option value=\"EC\">Ecuador</option><option value=\"EG\">Egypt</option><option value=\"SV\">El Salvador</option><option value=\"GQ\">Equatorial Guinea</option><option value=\"ER\">Eritrea</option><option value=\"EE\">Estonia</option><option value=\"ET\">Ethiopia</option><option value=\"FK\">Falkland Islands (Malvinas)</option><option value=\"FO\">Faroe Islands</option><option value=\"FJ\">Fiji</option><option value=\"FI\">Finland</option><option value=\"FR\">France</option><option value=\"GF\">French Guiana</option><option value=\"PF\">French Polynesia</option><option value=\"TF\">French Southern Territories</option><option value=\"GA\">Gabon</option><option value=\"GM\">Gambia</option><option value=\"GE\">Georgia</option><option value=\"DE\">Germany</option><option value=\"GH\">Ghana</option><option value=\"GI\">Gibraltar</option><option value=\"GR\">Greece</option><option value=\"GL\">Greenland</option><option value=\"GD\">Grenada</option><option value=\"GP\">Guadeloupe</option><option value=\"GU\">Guam</option><option value=\"GT\">Guatemala</option><option value=\"GG\">Guernsey</option><option value=\"GN\">Guinea</option><option value=\"GW\">Guinea-Bissau</option><option value=\"GY\">Guyana</option><option value=\"HT\">Haiti</option><option value=\"HM\">Heard Island and McDonald Islands</option><option value=\"VA\">Holy See (Vatican City State)</option><option value=\"HN\">Honduras</option><option value=\"HK\">Hong Kong</option><option value=\"HU\">Hungary</option><option value=\"IS\">Iceland</option><option value=\"IN\">India</option><option value=\"ID\">Indonesia</option><option value=\"IR\">Iran, Islamic Republic of</option><option value=\"IQ\">Iraq</option><option value=\"IE\">Ireland</option><option value=\"IM\">Isle of Man</option><option value=\"IL\">Israel</option><option value=\"IT\">Italy</option><option value=\"JM\">Jamaica</option><option value=\"JP\">Japan</option><option value=\"JE\">Jersey</option><option value=\"JO\">Jordan</option><option value=\"KZ\">Kazakhstan</option><option value=\"KE\">Kenya</option><option value=\"KI\">Kiribati</option><option value=\"KP\">Korea, Democratic People's Republic of</option><option value=\"KR\">Korea, Republic of</option><option value=\"KW\">Kuwait</option><option value=\"KG\">Kyrgyzstan</option><option value=\"LA\">Lao People's Democratic Republic</option><option value=\"LV\">Latvia</option><option value=\"LB\">Lebanon</option><option value=\"LS\">Lesotho</option><option value=\"LR\">Liberia</option><option value=\"LY\">Libya</option><option value=\"LI\">Liechtenstein</option><option value=\"LT\">Lithuania</option><option value=\"LU\">Luxembourg</option><option value=\"MO\">Macao</option><option value=\"MK\">Macedonia, the former Yugoslav Republic of</option><option value=\"MG\">Madagascar</option><option value=\"MW\">Malawi</option><option value=\"MY\">Malaysia</option><option value=\"MV\">Maldives</option><option value=\"ML\">Mali</option><option value=\"MT\">Malta</option><option value=\"MH\">Marshall Islands</option><option value=\"MQ\">Martinique</option><option value=\"MR\">Mauritania</option><option value=\"MU\">Mauritius</option><option value=\"YT\">Mayotte</option><option value=\"MX\">Mexico</option><option value=\"FM\">Micronesia, Federated States of</option><option value=\"MD\">Moldova, Republic of</option><option value=\"MC\">Monaco</option><option value=\"MN\">Mongolia</option><option value=\"ME\">Montenegro</option><option value=\"MS\">Montserrat</option><option value=\"MA\">Morocco</option><option value=\"MZ\">Mozambique</option><option value=\"MM\">Myanmar</option><option value=\"NA\">Namibia</option><option value=\"NR\">Nauru</option><option value=\"NP\">Nepal</option><option value=\"NL\">Netherlands</option><option value=\"NC\">New Caledonia</option><option value=\"NZ\">New Zealand</option><option value=\"NI\">Nicaragua</option><option value=\"NE\">Niger</option><option value=\"NG\">Nigeria</option><option value=\"NU\">Niue</option><option value=\"NF\">Norfolk Island</option><option value=\"MP\">Northern Mariana Islands</option><option value=\"NO\">Norway</option><option value=\"OM\">Oman</option><option value=\"PK\">Pakistan</option><option value=\"PW\">Palau</option><option value=\"PS\">Palestinian Territory, Occupied</option><option value=\"PA\">Panama</option><option value=\"PG\">Papua New Guinea</option><option value=\"PY\">Paraguay</option><option value=\"PE\">Peru</option><option value=\"PH\">Philippines</option><option value=\"PN\">Pitcairn</option><option value=\"PL\">Poland</option><option value=\"PT\">Portugal</option><option value=\"PR\">Puerto Rico</option><option value=\"QA\">Qatar</option><option value=\"RE\">Réunion</option><option value=\"RO\">Romania</option><option value=\"RU\">Russian Federation</option><option value=\"RW\">Rwanda</option><option value=\"BL\">Saint Barthélemy</option><option value=\"SH\">Saint Helena, Ascension and Tristan da Cunha</option><option value=\"KN\">Saint Kitts and Nevis</option><option value=\"LC\">Saint Lucia</option><option value=\"MF\">Saint Martin (French part)</option><option value=\"PM\">Saint Pierre and Miquelon</option><option value=\"VC\">Saint Vincent and the Grenadines</option><option value=\"WS\">Samoa</option><option value=\"SM\">San Marino</option><option value=\"ST\">Sao Tome and Principe</option><option value=\"SA\">Saudi Arabia</option><option value=\"SN\">Senegal</option><option value=\"RS\">Serbia</option><option value=\"SC\">Seychelles</option><option value=\"SL\">Sierra Leone</option><option value=\"SG\">Singapore</option><option value=\"SX\">Sint Maarten (Dutch part)</option><option value=\"SK\">Slovakia</option><option value=\"SI\">Slovenia</option><option value=\"SB\">Solomon Islands</option><option value=\"SO\">Somalia</option><option value=\"ZA\">South Africa</option><option value=\"GS\">South Georgia and the South Sandwich Islands</option><option value=\"SS\">South Sudan</option><option value=\"ES\">Spain</option><option value=\"LK\">Sri Lanka</option><option value=\"SD\">Sudan</option><option value=\"SR\">Suriname</option><option value=\"SJ\">Svalbard and Jan Mayen</option><option value=\"SZ\">Swaziland</option><option value=\"SE\">Sweden</option><option value=\"CH\">Switzerland</option><option value=\"SY\">Syrian Arab Republic</option><option value=\"TW\">Taiwan, Province of China</option><option value=\"TJ\">Tajikistan</option><option value=\"TZ\">Tanzania, United Republic of</option><option value=\"TH\">Thailand</option><option value=\"TL\">Timor-Leste</option><option value=\"TG\">Togo</option><option value=\"TK\">Tokelau</option><option value=\"TO\">Tonga</option><option value=\"TT\">Trinidad and Tobago</option><option value=\"TN\">Tunisia</option><option value=\"TR\">Turkey</option><option value=\"TM\">Turkmenistan</option><option value=\"TC\">Turks and Caicos Islands</option><option value=\"TV\">Tuvalu</option><option value=\"UG\">Uganda</option><option value=\"UA\">Ukraine</option><option value=\"AE\">United Arab Emirates</option><option value=\"GB\">United Kingdom</option><option value=\"US\">United States</option><option value=\"UM\">United States Minor Outlying Islands</option><option value=\"UY\">Uruguay</option><option value=\"UZ\">Uzbekistan</option><option value=\"VU\">Vanuatu</option><option value=\"VE\">Venezuela, Bolivarian Republic of</option><option value=\"VN\">Viet Nam</option><option value=\"VG\">Virgin Islands, British</option><option value=\"VI\">Virgin Islands, U.S.</option><option value=\"WF\">Wallis and Futuna</option><option value=\"EH\">Western Sahara</option><option value=\"YE\">Yemen</option><option value=\"ZM\">Zambia</option><option value=\"ZW\">Zimbabwe</option></select>"
                                     + "<h3>Your city (between 3 and 20 characters):</h3><input id='city_input' type='text' value='Paris?' maxlength='20'></input>"
                                     + "<h4>Close this dialog to skip this step</h4>"
                                     + "</div>");
                    // open modal
                    modal.open();
                    form_to_be_submitted = false; // form to be submitted when modal is closed
                  }
                }
                else {
                  if ( (!localStorage.firstname)
                       && (gamesok >= 3) // (coherent with "history_clear_advice")
                       && (attempts >= 4) // (game not too easy)
                       && ( (gamesok <= 5) || ((gamesok % 2) == 1) ) // (do not ask first name too often if not filled)
                       && ( (gamesok >= 12) || ((gamesok >= 5) && (score >= 33)) || ((nbcolumns == 4) && (score >= 33)) || ((nbcolumns == 5) && (score >= 44)) || ((nbcolumns >= 6) && (score >= 67)) ) ) { // (experienced player)
                    if (modal_mode == -1) {
                      modal_mode = 2;
                      // set modal content
                      modal.setContent("<div style='-webkit-touch-callout: none; /* iOS Safari */ -webkit-user-select: none; /* Safari */ -khtml-user-select: none; /* Konqueror HTML */ -moz-user-select: none; /* Firefox */ -ms-user-select: none; /* Internet Explorer/Edge */ user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */'>"
                                       + "<h2>You seem to be an experienced player!<br>Please enter your first name, it will be used to store your scores:</h2>"
                                       + "<h3>Your first name (between 3 and 12 letters, no spaces):</h3><input id='firstname_input' type='text' value='John?' maxlength='12'></input>"
                                       + "<h4>To store your future scores properly (with your first name), make sure that your browser does not clear cookies/site data when exited...<br>Close this dialog to skip this step</h4>"
                                       + "</div>");
                      // open modal
                      modal.open();
                      form_to_be_submitted = false; // form to be submitted when modal is closed
                    }
                  }
                }
              }

              console.log("(run completed)");

              if (form_to_be_submitted) {
                submitForm();
              }
              else {
                console.log("(form submission skipped)");
              }

            }, // run

            geolocation_retry: function (jqxhr, textStatus, error) {
              var errorStr = ("geolocation failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
              if (typeof(Storage) !== 'undefined') {
                if (localStorage.firstname) {
                  errorStr = errorStr + " for " + localStorage.firstname;
                }
                else if (localStorage.firstaccessid) {
                  errorStr = errorStr + " for first access id " + localStorage.firstaccessid;
                }
                if (localStorage.countryname) {
                  errorStr = errorStr + " in " + localStorage.countryname;
                }
                if (localStorage.cityname) {
                  errorStr = errorStr + " in " + localStorage.cityname;
                }
                if (localStorage.gamesok) {
                  errorStr = errorStr + " after " + localStorage.gamesok + " game(s)";
                }
              }
              errorStr = errorStr + " |nbcolumns:" + nbcolumns + "|score:" + score + "|attempts:" + attempts + "|time:" + timestr;
              console.log(errorStr);
              // submitForm(errorStr, true); => skipped as this may be part of a frequent use case (*)
              geolocation_handler.first_geolocation_errorStr = errorStr;

              // Keep some time between the 2 potential calls to submitForm() -> no longer applicable (*)
              // This may also allow to make the 2nd getJSON in different mobile network conditions
              let now = new Date().getTime();
              while(new Date().getTime() < now + 111){}; // (interface is frozen during this short time)

              // Another geolocation server is used
              geolocation_handler.nb_JSON_queries_posted++;
              if (geolocation_handler.nb_JSON_queries_posted > 2) {
                console.log("error: too many recursive calls to run()! (#1)");
                return; // defense against infinite loops
              }
              $.getJSON('https://api.ipinfodb.com/v3/ip-city/?key=e61c60ef2fd204e654c2dbe9cd5f4d48c325e6b9ec666a9d76466fab576a9ce6&format=json', geolocation_handler.run_retry)
              .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
                var errorStr = ("geolocation retry failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
                let html_geoloc_already_done_str = "";
                if (typeof(Storage) !== 'undefined') {
                  if (localStorage.firstname) {
                    errorStr = errorStr + " for " + localStorage.firstname;
                  }
                  else if (localStorage.firstaccessid) {
                    errorStr = errorStr + " for first access id " + localStorage.firstaccessid;
                  }
                  if (localStorage.countryname) {
                    errorStr = errorStr + " in " + localStorage.countryname;
                  }
                  if (localStorage.cityname) {
                    errorStr = errorStr + " in " + localStorage.cityname;
                  }
                  if (localStorage.gamesok) {
                    errorStr = errorStr + " after " + localStorage.gamesok + " game(s)";
                  }
                  if (localStorage.html_geoloc_already_done) {
                    html_geoloc_already_done_str = "|HTML geolocation status:" + localStorage.html_geoloc_already_done;
                  }
                }
                errorStr = errorStr + " |nbcolumns:" + nbcolumns + "|score:" + score + "|attempts:" + attempts + "|time:" + timestr + "|last_data_used_not_null:" + (last_data_used != null) + "|first_geolocation_error:" + geolocation_handler.first_geolocation_errorStr + html_geoloc_already_done_str + "|html_compatibility_game_version:" + html_compatibility_game_version;
                console.log(errorStr);

                // Reuse last (valid or not) geolocation data if any
                if (last_data_used != null) {
                  geolocation_handler.nb_JSON_queries_posted++;
                  console.log("reuse last (valid or not) geolocation data");
                  geolocation_handler.run(last_data_used);
                }
                else {
                  var fixed_ip_address = geolocation_handler.getIpAddressForIdentifiedUser();
                  if (fixed_ip_address != "") { // Identified user
                    geolocation_handler.nb_JSON_queries_posted++;
                    console.log("use fixed IP address: " + fixed_ip_address);
                    var fixed_data = {'ip':fixed_ip_address};
                    geolocation_handler.run(fixed_data);
                  }
                  else if ( (typeof(Storage) !== 'undefined')
                            && localStorage.automaticPositioning && localStorage.countryname && localStorage.regionname && localStorage.cityname ) { // Relevant location
                    geolocation_handler.nb_JSON_queries_posted++;
                    var sum = 0;
                    // regionname is used instead of cityname below to better identify unique players
                    // => one unique "geolocation retry failure" player is supported per region
                    for (var i = 0; i < localStorage.regionname.length; i++) {
                      sum = sum + localStorage.regionname.charCodeAt(i);
                    }
                    var inferred_ip_address = "2.2.2." + String(sum % 256);
                    console.log("use inferred IP address: " + inferred_ip_address);
                    var inferred_data = {'ip':inferred_ip_address};
                    geolocation_handler.run(inferred_data);
                  }
                  else { // No form is submitted in this retry failure case
                    alert("If you accept to share your location,\nthis information will be used to store your score\nand you will also see the other players scores and rankings"); // (duplicated line)
                    submitForm(errorStr, true);
                    attempt_HTML_geolocation(true); // Subject to user acceptance
                  }
                }
              })
              .always(function() {
                console.log("(getJSON completed #2)");
              });
            }, // geolocation_retry

            getIpAddressForIdentifiedUser: function () { // "Reliable" users having played for a certain time, whose location is unknown and who did not want to share it
              if (typeof(Storage) !== 'undefined') {
                if (localStorage.firstaccessid) {
                  if (localStorage.firstaccessid.indexOf("FA - 0KQI0 - Fri Jan 12 2018") != -1) {
                    return "1.1.1.1"; // (unique fixed IP address)
                  }
                  /* else if (localStorage.firstaccessid.indexOf("FA - 8Q0RU - Wed Feb 07") != -1) {
                    return "1.1.1.2"; // (unique fixed IP address)
                  } */
                  // Note: "2.2.2.x" IP addresses shall not be used here, as used for another case
                }
                return "";
              }
              return "";
            },


          } // geolocation_handler

          geolocation_handler.nb_JSON_queries_posted++;
          if (geolocation_handler.nb_JSON_queries_posted > 2) {
            console.log("error: too many recursive calls to run()! (#2)");
            return; // defense against infinite loops
          }
          $.getJSON('https://api.ipdata.co', geolocation_handler.run)
          .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
            geolocation_handler.geolocation_retry(jqxhr, textStatus, error);
          })
          .always(function() {
            console.log("(getJSON completed #1)");
          });

          console.log("(store player info exit)");

        }
        catch (exc) {
          console.log("internal error while storing scores: " + exc);
          if (nb_errors_submitted == 0) {
            // alert("Oops... an internal error occurred: " + exc);
            submitForm("internal error while storing scores: " + exc, true);
            nb_errors_submitted++;
          }
        }

      } // store_player_info

      // ***********************
      // Handle page access info
      // ***********************

      var initial_time = new Date().getTime();
      function submitAccessForm(data, access_type, debug_info) {
        var final_time = new Date().getTime();
        if (final_time - initial_time > 999000) { // 15min+delta max - See (**)
          return;
        }
        var timeStr = String(Math.floor((final_time - initial_time)/1000));
        if (access_type.indexOf(" in") != -1) {
          timeStr = "";
        }
        var countryNameStr = "-";
        if ((data != null) && (typeof data.country_name != 'undefined')) {
          countryNameStr = String(data.country_name).trim();
        }
        var regionNameStr = "-";
        if ((data != null) && (typeof data.region != 'undefined')) {
          regionNameStr = String(data.region).trim();
        }
        var cityNameStr = "-";
        if ((data != null) && (typeof data.city != 'undefined')) {
          cityNameStr = String(data.city).trim();
        }
        var ipAddressStr = "-";
        if ((data != null) && (typeof data.ip != 'undefined')) {
          ipAddressStr = String(data.ip).trim();
        }
        var firstAccessIdStr = "-";
        if (typeof(Storage) !== 'undefined') {
          if (localStorage.firstaccessid) {
            firstAccessIdStr = localStorage.firstaccessid;
          }
        }
        var debugStr = navigator.userAgent + "/initial: " + initial_time + "/final: " + final_time + "/debug_info:" + debug_info;
        submitForm('-&' + 'page=' + access_type + '&' + 'timeonpage=' + timeStr + '&' + 'country=' + countryNameStr + '&region=' + regionNameStr + '&city=' + cityNameStr + '&nbgameswon=' + ((nbGamesPlayedAndWon==0)?"-":String(nbGamesPlayedAndWon)) + '&nbgames=' + ((nbGamesPlayed==0)?"-":String(nbGamesPlayed)) + '&nbcodes=' + ((nbCodesPlayed==0)?"-":String(nbCodesPlayed)) + '&ipaddress=' + ipAddressStr + '&firstaccessid=' + firstAccessIdStr + '&debug=' + debugStr, true, 111);
      }

      function storeFirstAccess(access_type, timeToWait1, timeToWait2, debug_info) {
        if (firstAccess) {
          // Keep some time between the 2 potential calls to submitAccessForm()
          let now = new Date().getTime();
          while(new Date().getTime() < now + timeToWait1){}; // (interface is frozen during this short time)
          if (last_data_used != null) {
            submitAccessForm(last_data_used, access_type, debug_info);
          }
          else {
            submitAccessForm(null, access_type, debug_info);
          }
          // Keep some time between the 2 potential calls to submitAccessForm()
          now = new Date().getTime();
          while(new Date().getTime() < now + timeToWait2){}; // (interface is frozen during this short time)
        }
      }

      function firstAccessGeolocFailure(jqxhr, textStatus, error) {
        var errorStr = ("first access geolocation failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
        console.log(errorStr);
        $.getJSON('https://api.ipinfodb.com/v3/ip-city/?key=e61c60ef2fd204e654c2dbe9cd5f4d48c325e6b9ec666a9d76466fab576a9ce6&format=json', function(data_p) {
          /* ipinfodb.com response format:
             - SUCCESS case:
              statusCode	"OK"
              statusMessage	""
              ipAddress	"94.239.111.222"
              countryCode	"FR"
              countryName	"France"
              regionName	"Ile-de-France"
              cityName	"Paris"
              zipCode	"75000"
              latitude	"48.8534"
              longitude	"2.3488"
              timeZone	"+01:00"
            - FAILURE case:
              statusCode	"ERROR"
              statusMessage	"Invalid IP Address."
              ipAddress	"994.239.111.222"
              countryCode	""
              countryName	""
              regionName	""
              cityName	""
              zipCode	""
              latitude	"0"
              longitude	"0"
              timeZone	""
          */
          let converted_data = JSON.stringify(data_p);

          // latitude -> latitude
          // longitude -> longitude
          // countryName -> country_name
          converted_data = converted_data.replace("countryName", "country_name");
          // regionName -> region
          converted_data = converted_data.replace("regionName", "region");
          // cityName -> city
          converted_data = converted_data.replace("cityName", "city");
          // ipAddress -> ip
          converted_data = converted_data.replace("ipAddress", "ip");

          last_data_used = JSON.parse(converted_data);
          firstgamegeoloc = "fa2";
          storeFirstAccess('game', 444, 444 /* (a too low value here will not work) */, 'debug-ok2');
        })
        .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
          var errorStr = ("first access geolocation retry failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
          console.log(errorStr);
          storeFirstAccess('game', 444, 444 /* (a too low value here will not work) */, 'debug-fail');
          // setTimeout("attempt_HTML_geolocation(false)", 25000); // Subject to user acceptance => not done because may prevent future requests in case of initial rejection
        })
        .always(function() {
          console.log("(getJSON completed #i2)");
        });
      }

      $.getJSON('https://api.ipdata.co', function(data) {
        firstgamegeoloc = "fax";
        last_data_used = data;
        if ( ((typeof data.ip != 'undefined') && (String(data.ip).trim().length >= 7 /* 0.0.0.0 */)) // (redundant lines)
             && ((typeof data.city != 'undefined') && (String(data.city).trim().length >= 3)) ) { // (redundant lines)
          firstgamegeoloc = "fa1";
          storeFirstAccess('game', 444, 444 /* (a too low value here will not work) */, 'debug-ok1');
        }
        else {
          return firstAccessGeolocFailure("", "manual first access geolocation retry due to invalid geolocation data", "");
        }
      }) // to simplify, failure cases are not handled in a more complex way
      .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
        firstAccessGeolocFailure(jqxhr, textStatus, error);
      })
      .always(function() {
        console.log("(getJSON completed #i1)");
      });

      if (firstAccess) {
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-ini')",        44);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-5s')",       5000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-10s')",     10000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-15s')",     15000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-20s')",     20000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-30s')",     30000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-40s')",     40000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-50s')",     50000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-1min')",    60000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-1min30')",  90000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-2min')",   120000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-2min30')", 150000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-3min')",   180000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-4min')",   240000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-5min')",   300000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-10min')",  600000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-15min')",  900000); // See (**)
      }

    </script>

  </body>

</html>
<!DOCTYPE html>
<html lang="en">

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Super Master Mind</title> <!-- (this title will be overwritten) -->
    <meta name="robots" content="noindex"> <!-- (this page shall be preferably accessed from the main site page) -->
    <meta name="title" content="Super Master Mind">
    <meta name="description" content="Play Super Master Mind / Code breaker online, assisted by a calculator which knows the optimal strategy!">
    <meta name="keywords" content="super master mind, code breaker, game, online, optimal strategy, javascript">

    <!-- no viewport tag in this page as it makes canvas fuzzy! -->

    <!-- Remote console at http://console.re/supermastermind displaying console text (provided all calls to "console.log(xxx)" are replaced by "console.re.log(xxx)")
         and console errors (provided the .js scripts to be debugged are copied/pasted directly into this HTML file between <script>...</script> tags,
         otherwise error details, among which error line numbers, will be lost):
      <script src="https://console.re/connector.js" data-channel="supermastermind" id="consolerescript"></script>
      <script>console.re.log('remote log enabled!');</script>
    -->

    <style>
      /* *** Main styles *** */
      body {
        font-family: 'Verdana';
        margin: 0%;
        padding: 0%;
        /* border: thin solid white; */
        color: #777777;
        font-size: calc(7px + .34vw);
        background: black;
      }
      #my_canvas {
        margin: 0;
        padding: 0;
        border: 2px solid purple; /* (duplicated in SuperMasterMind.js for proper canvas's width & height calculation) */
        background: white;
        width: 98.5%;
        height: 93%;
        border-radius: 1.5%;
        zoom: 1.0; /* (used by Chrome, ignored by Firefox) */
      }
      /* *** Classes for button styling using CSS *** */
      .button {
        font-family: Verdana;
        background-color: white;
        border: 2px solid purple;
        color: black;
        padding: 1.0vh 0.5vw 1.0vh 0.5vw; /* top right bottom left */
        text-align: center;
        text-decoration: none;
        /* font-size: 15px; */
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        display: block;
        margin-top: 1.0vh;
        margin-bottom: 1.0vh;
        border-radius: 20%;
        -webkit-backface-visibility: visible;
      }
      .button:hover {
        background-color: purple;
        color: white;
      }
      .disabled {
          opacity: 0.4;
          font-weight: normal;
          cursor: not-allowed;
      }
      /* Safari 4.0 - 8.0 */
      @-webkit-keyframes glowing {
        0%   {background-color: white;}
        20%  {background-color: white;}
        33%  {background-color: purple;}
        47%  {background-color: white;}
        60%  {background-color: purple;}
        73%  {background-color: white;}
        87%  {background-color: purple;}
        100% {background-color: white;}
      }
      /* Standard syntax */
      @keyframes glowing {
        0%   {background-color: white;}
        20%  {background-color: white;}
        33%  {background-color: purple;}
        47%  {background-color: white;}
        60%  {background-color: purple;}
        73%  {background-color: white;}
        87%  {background-color: purple;}
        100% {background-color: white;}
      }

      .blinking {
        -webkit-animation-name: glowing; /* Safari 4.0 - 8.0 */
        -webkit-animation-duration: 3.75s; /* Safari 4.0 - 8.0 */
        animation-name: glowing;
        animation-duration: 3.75s;
        -webkit-backface-visibility: hidden;
       }
      .fast_blinking {
        -webkit-animation-name: glowing; /* Safari 4.0 - 8.0 */
        -webkit-animation-duration: 2.75s; /* Safari 4.0 - 8.0 */
        animation-name: glowing;
        animation-duration: 2.75s;
        -webkit-backface-visibility: hidden;
       }

      .radio {
        font-family: Verdana;
        color: black;
        white-space: nowrap; /* no line breaks */
        padding: 0;
        margin: 0;
        text-align: left;
        text-decoration: none;
        /* font-size: 14px; */
        font-weight: bold;
        box-shadow: none;
        /* text not selectable */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .game_loading /* (used during page loading) */
      { position: fixed;
        height: 100%;
        width: 100%;
        top:0;
        left: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index:11111;
        font-size: 2.0vh;
        text-align: center;
        padding-top: 25.0vh;
        color: #fff;
        /* text not selectable */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .page_transition /* (used during page transition) */
      { position: fixed;
        height: 100%;
        width: 100%;
        top:0;
        left: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index:11111;
        font-size: 2.0vh;
        text-align: center;
        padding-top: 25.0vh;
        color: #fff;
        /* text not selectable */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .game_aborted /* (used at game abortion) */
      { position: fixed;
        height: 100%;
        width: 100%;
        top:0;
        left: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index:11111;
        font-size: 2.0vh;
        text-align: center;
        padding-top: 25.0vh;
        color: #fff;
        /* text not selectable */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

    </style>

    <script>
      var globalErrorStatus = 0;
      try {
        eval('"use strict"; class foo {}; let test_let_inst = 1;'); // Interner Explorer does not support classes and old versions of Safari (< 10) will fail on the "let" instruction (error tested on Safari 9.1)
      } catch (err) {
        var errorMsg = "Your browser cannot run this game. This game can be run with the last versions of Chrome, Firefox, Edge and Safari: update your browser version if necessary.";
        alert(errorMsg);
        globalErrorStatus = 1;
        throw new Error(errorMsg);
      }
      if (typeof(Worker) == "undefined") {
        var workerErrorMsg = "Your browser cannot run this game because it does not support Web workers. This game can be run with the last versions of Chrome, Firefox, Edge and Safari: update your browser version if necessary.";
        alert(workerErrorMsg);
        globalErrorStatus = 2;
        throw new Error(workerErrorMsg);
      }

      var userAgentStr = "";
      var android_appli = false;
      var versionNameStr = "?";
      var versionCodeStr = "-1";
      try {
        var androidAppliInfoStr = new URL(decodeURI(location.href)).searchParams.get("android_appli");
        if (androidAppliInfoStr != null) { // check if ...?android_appli=xxx in the URL
          userAgentStr = "Android appli sdk:" + androidAppliInfoStr + " ";
          android_appli = true;
          try {
            versionNameStr = new URL(decodeURI(location.href)).searchParams.get("version_name");
            if (versionNameStr == null) {
              versionNameStr = "?";
            }
            versionCodeStr = new URL(decodeURI(location.href)).searchParams.get("version_code");
            if (versionCodeStr == null) {
              versionCodeStr = "?";
            }
            var playerIdStr = new URL(decodeURI(location.href)).searchParams.get("player_id");
            if (playerIdStr != null) {
              if (!localStorage.playerid) {
                localStorage.playerid = playerIdStr;
              }
            }
          } catch (err_versioning) {}
          userAgentStr = userAgentStr + "vn:" + versionNameStr + " vc:" + versionCodeStr + " ";
        }
        userAgentStr = userAgentStr + navigator.userAgent;
      } catch (err) {
        userAgentStr = "??? " + navigator.userAgent;
      }
      var rulesTableWidthStr = "44%";
      var scoresTableWidthStr = "100%";
      var scoresFontSizeStr = "1.6vw";
      var abbreviateScores = true;

      var nbGamesPlayedAndWon = 0;
      var someGamesWereWon = false;
      var nbGamesPlayed = 0;
      var nbCodesPlayed = 0;
      var nbColorSelections = 0;
      var gameRulesDisplayed = false;
      var debug_game_state = -1;
      var debug_on_unload = 0;
      var storageErrorMet = true;
      try {
        if (typeof(Storage) !== 'undefined') {
          localStorage.test_storage_ok = "abc";
          if (localStorage.test_storage_ok == "abc") {
            storageErrorMet = false;
          }
        }
      }
      catch (exc) {
      }
      if (storageErrorMet) {
        // Note: such an error occurs for Edge run locally
        var storageErrorMsg = "Your browser cannot run this game because it cannot store local data. This game can be run with the last versions of Chrome, Firefox, Edge and Safari: update your browser version if necessary.";
        alert(storageErrorMsg);
        globalErrorStatus = 3;
        throw new Error(storageErrorMsg);
      }

      if (!localStorage.firstgamegeoloc) { // Keep existing value if it exists
        localStorage.firstgamegeoloc = "fa";
      }
    </script>
    <script src='lib/jquery-3.4.1.min.js'></script>
    <script>
      // Animation during page loading:
      // 1) when document is ready
      $(document).ready(function () {
        console.log("(ready)");
        // Less beautiful + can put some problems with Chrome while drawing canvas: $(".mainxxx").hide(); // hide the mainxxx div
      });
      // 2) when all elements of the page are completely loaded
      $(window).on('load', function() {
        console.log("(on load)");
        // $(".game_loading").fadeOut("slow"); // game_loading div fades out -> postponed after all scripts have been loaded
        // Less beautiful + can put some problems with Chrome while drawing canvas: $(".mainxxx").fadeIn("slow"); // mainxxx div fades in
      });
      // 2') Defense timeout to allow interactions with the page
      // setTimeout("console.log('(on load timeout)');$('.game_loading').fadeOut('slow');", 5000); // game_loading div fades out -> not applied

      $(window).on('beforeunload', function() { // Ask for a confirmation on window exit when a game is ongoing (***)
        if (!android_appli) { // in case of android_appli, webview reload can be (a bit) delayed
          try {
            debug_on_unload = 1;
            if (gameOnGoing() && (currentAttemptNumber > 1)) {
              if (someGamesWereWon && (nbColumns >= 5)) { // (condition duplicated)
                return "Do you really want to abort current game?"; // (message not displayed by all browsers, some browsers will display a generic message instead - code duplicated)
              }
            }
          }
          catch (exc) {
            console.log("error encountered at game abortion: " + exc);
            return; // (no confirmation asked)
          }
        }
      });

      function makeid() {
        let text = "";
        let possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        for (let i = 0; i < 5; i++) {
          text += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return text;
      }

      function formatDate(date) {
        if (date == null) {
          return "?";
        }
        day = String(date.getDate());
        if (day.length < 2) {
          day = '0' + day;
        }
        month = String(date.getMonth() + 1);
        if (month.length < 2) {
          month = '0' + month;
        }
        year = String(date.getYear()-100);
        return "-" + day + month + year; // (versus "_ddMMyy" in android appli)
      }

      let firstAccess = false;
      if (typeof(Storage) !== 'undefined') {
        if (!localStorage.firstgameaccessdone) {
          localStorage.firstgameaccessdone = "first game access done";
          firstAccess = true;
        }
        if (!localStorage.firstaccessid) {
          let firstaccessid = 'GA - ' + makeid() + formatDate(new Date());
          localStorage.firstaccessid = firstaccessid;
        }
      }

      let nbLocationURLs = 3;
      let locationURLs = new Array(nbLocationURLs);
      locationURLs[0] = 'https://api.ipdata.co/en?api-key=1b31a83f2dc4ead71542c7df3dc4850ce22fed68341a7f3b46ab67b2';
      locationURLs[1] = 'https://api.ipinfodb.com/v3/ip-city/?key=e61c60ef2fd204e654c2dbe9cd5f4d48c325e6b9ec666a9d76466fab576a9ce6&format=json'; // (specific conversion for this dimension index [1])
      locationURLs[2] = 'https://ipinfo.io/json/?token=ca832119df7bb5'; // (specific conversion for this dimension index [2])

    </script>

    <link rel='stylesheet' type='text/css' href='lib/tingle-master/dist/tingle.min.css'>
  </head>

  <body onresize="eval('try{draw_graphic();}catch(e){}');" onunload="/* See (***) */ debug_on_unload = 2;console.log('exit...');storeFirstAccess('game', 777, 777 /* (a too low value here will not work) */, 'debug-out');">

    <div id="game_loading_id" class="game_loading">
      <img src='img/loading.gif' style='height:12%;'><br>Loading... <!-- (not rem unit as no viewport! / duplicated code) -->
    </div>

    <div class="page_transition" style='display:none;'>
    </div>

    <div class="game_aborted" style='display:none;'>
      Current game was aborted!
      <script>
        if (typeof(Storage) !== 'undefined') {
          if (localStorage.firstname && localStorage.gamesok && (Number(localStorage.gamesok) >= 30)) {
            someGamesWereWon = true;
            document.write("<hr style='height:0.75vh; visibility:hidden;' />You shall win 5 consecutive games<br>to get your \"last5\" score<br>computed and compared to other players'");
          }
        }
      </script>
      <br>
      <img src="img/loading.gif" style='height:12%;'><br>  <!-- (not rem unit as no viewport!) -->
      Starting a new game...
    </div>

    <!-- HTML controls and canvas -->

    <table id='my_table' style='background:#E3E3E3;width:75%;height:90%;position:absolute;left:12.5%;top:2%;border:5px ridge white;border-radius:1%;margin:0;padding:0;'>
      <tr style='height:100%;'>
        <td style='width:0.1%;margin:0;padding:0;'></td>
        <td style='width:6.2%;margin:0;padding:0;vertical-align:middle;text-align:center;white-space:nowrap'>
          <input id='newGameButton' class='button disabled' type='button' value='NEW GAME' title='Start a new game' onclick='newGameButtonClick(0)' onfocus='this.blur()' style='margin-bottom:0.5vh;' disabled>
          <form action=''>
            <label title='Very easy'>&nbsp;&nbsp;&nbsp;<input id='columnslabel_3b' class='radio disabled' type='radio' value='3' name='nbColumnsSelection' style='vertical-align:middle;' onclick='newGameButtonClick(3)' disabled></label>
              <label title='Very easy' onclick="$('#columnslabel_3b').prop('checked', true);newGameButtonClick(3);"><span id='columnslabel_3' class='radio disabled' style='vertical-align:middle;'> 3 columns&nbsp;<br></span></label>
            <label title='Master Mind'>&nbsp;&nbsp;&nbsp;<input id='columnslabel_4b' class='radio disabled' type='radio' value='4' name='nbColumnsSelection' style='vertical-align:middle;' onclick='newGameButtonClick(4)' disabled></label>
              <label title='Master Mind' onclick="$('#columnslabel_4b').prop('checked', true);newGameButtonClick(4);"><span id='columnslabel_4' class='radio disabled' style='vertical-align:middle;'> 4 columns&nbsp;<br></span></label>
            <label title='Super Master Mind'>&nbsp;&nbsp;&nbsp;<input id='columnslabel_5b' class='radio disabled' type='radio' value='5' name='nbColumnsSelection' style='vertical-align:middle;' onclick='newGameButtonClick(5)' disabled></label>
              <label title='Super Master Mind' onclick="$('#columnslabel_5b').prop('checked', true);newGameButtonClick(5);"><span id='columnslabel_5' class='radio disabled' style='vertical-align:middle;'> 5 columns&nbsp;<br></span></label>
            <label title='Advanced Master Mind'>&nbsp;&nbsp;&nbsp;<input id='columnslabel_6b' class='radio disabled' type='radio' value='6' name='nbColumnsSelection' style='vertical-align:middle;' onclick='newGameButtonClick(6)' disabled></label>
              <label title='Advanced Master Mind' onclick="$('#columnslabel_6b').prop('checked', true);newGameButtonClick(6);"><span id='columnslabel_6' class='radio disabled' style='vertical-align:middle;'> 6 columns&nbsp;<br></span></label>
            <label title='Ultra Master Mind'>&nbsp;&nbsp;&nbsp;<input id='columnslabel_7b' class='radio disabled' type='radio' value='7' name='nbColumnsSelection' style='vertical-align:middle;' onclick='newGameButtonClick(7)' disabled></label>
              <label title='Ultra Master Mind' onclick="$('#columnslabel_7b').prop('checked', true);newGameButtonClick(7);"><span id='columnslabel_7' class='radio disabled' style='vertical-align:middle;'> 7 columns&nbsp;<br></span></label>
          </form>
          <input id='resetCurrentCodeButton' class='button disabled' type='button' value='Reset current code' title='Reset current code' onclick='resetCurrentCodeButtonClick()' onfocus='this.blur()' disabled>
          <input id='playRandomCodeButton' class='button disabled' type='button' value='Play random code' title='Play a random code' onclick='playRandomCodeButtonClick()' onfocus='this.blur()' disabled>
          <input id='revealSecretColorButton' class='button disabled' type='button' value='Reveal secret color' title='Reveal a color of the secret code' onclick='revealSecretColorButtonClick()' onfocus='this.blur()' disabled>
          <input id='showPossibleCodesButton' class='button disabled' type='button' value='Show possible codes' title='Show possible codes at each stage of the game (when game is over)' onfocus='this.blur()' onclick='showPossibleCodesButtonClick()' disabled>
        </td>
        <td style='width:0.1%;margin:0;padding:0;'></td>
        <td style='width:93.6%;margin:0;padding:0;vertical-align:middle;align:right;text-align:left;'><canvas id='my_canvas'><font color=red>Error: HTML canvas are not supported!</font></canvas></td>
      </tr>
    </table>

    <!-- Display extra text and pictures -->

    <p style='text-align:right'>
      <script>
        if (typeof(Storage) !== 'undefined') {
          let welcome_str = "Welcome";
          try {
            if ((navigator.language == "fr") || (navigator.language.indexOf("fr-") == 0)) { // covers "fr", "fr-FR", "fr-BE", "fr-CA", "fr-CH", "fr-LU"
              welcome_str = "Bienvenue";
            }
          }
          catch (exc) {}
          if (localStorage.firstname) {
            document.write("<font color=#DDDDDD><span id='welcome_id' style='float:left;'>&nbsp;&nbsp;" + welcome_str + " <b><font color=yellow>" + localStorage.firstname + "</font></b>!</span></font>");
            setTimeout(function() {
              $("#welcome_id").fadeOut().empty();
            }, 60000);
          }
        }
      </script>
      <b><a href='index.html'>&#x2302; Main page</a></b>&nbsp;&nbsp;&nbsp;<br>
      <b><a href='index.html#game_rules'>&#x2302; Game rules</a></b>&nbsp;&nbsp;&nbsp;<br>
      <b><a href='screenshots.html'>&#x2302; Game examples</a></b>&nbsp;&nbsp;&nbsp;<br>
      <b><a href='optimal_strategy.html'>&#x2302; Optimal strategy</a></b>&nbsp;&nbsp;&nbsp;<br>
      <b><a href='contact_info.html'>&#x2302; Contact info</a></b>&nbsp;&nbsp;&nbsp;<br><br>
      <script>
        {
          var date = new Date();
          var m = date.getMonth();
          var d = date.getDate();
          if ( ((m == 11) && (d >= 8)) // after December 8th
               || ((m == 0) && (d <= 8)) ) { // before January 8th
            // (Display values will be updated below if necessary)
            document.write("<img id='img_1' style='display:none;' src='img/End_of_year.png'>&nbsp;<br><img id='img_2' style='display:none;' src='img/End_of_year2.png'>&nbsp;");
          }
        }
      </script>
    </p>

    <!-- Initializations -->

    <script>
      let html_compatibility_game_version = "Ver_MH3";
      let nb_errors_submitted = 0;
      let mobileMode = false;
      let androidMode = false;
      let modeAlreadySelected = false;
      let lastKeyCheck = false;
      document.body.onkeydown = function(e) {
        if (modeAlreadySelected) {
          return;
        }
        let keycheck1 = (String.fromCharCode(e.keyCode).toLowerCase() == '1');
        let keycheck2 = ((String.fromCharCode(e.keyCode).toLowerCase() == 'l') && e.shiftKey);
        if (keycheck1 && (!lastKeyCheck)) {
          lastKeyCheck = true;
        }
        else if (keycheck2 && lastKeyCheck) {
          var mode = prompt("Which mode do you want to select?", "444");
          if (mode != null) {
            document.getElementById('form_list_id').value = mode.trim();
            setTimeout("submitForm();", 444);
          }
          modeAlreadySelected = true;
        }
        else {
          lastKeyCheck = false;
        }
      };
      // Set AJAX timeout to X seconds (this will set all AJAX requests the program makes, even via $.getJSON, to have a timeout of X seconds)
      $.ajaxSetup({
        timeout: 40000 // 40 seconds
      });
    </script>

    <!-- Handle player's info -->

    <script src='lib/tingle-master/dist/tingle.min.js'></script>
    <script>

      var modal_mode = -1;
      var store_time = new Date().getTime();

      var modal = new tingle.modal({
          footer: false,
          stickyFooter: false,
          closeMethods: ['overlay', 'button', 'escape'],
          // closeMethods: ['button'],
          closeLabel: "Close",
          cssClass: ['custom-class-1', 'custom-class-2'],
          onOpen: function() {
            console.log('(modal onOpen)');
          },
          onClose: function() {
            console.log('(modal onClose)');
          },
          beforeClose: function() {

            console.log('(modal beforeClose)');
            if (modal_mode == 1) {

              // Get firstname entered
              try {
                let firstname_entered = document.getElementById("firstname_input").value;
                firstname_entered = firstname_entered.trim();
                if ( (firstname_entered.length >= 3) && (firstname_entered.length <= 11) && (/^[A-Za-zÀ-ÿ'-]+$/.test(firstname_entered)) /* (only letters) */ && isCorrect(firstname_entered) ) {
                  if (typeof(Storage) !== 'undefined') {
                    localStorage.firstname = capitalizeFirstLetters(firstname_entered);
                  }
                }
                else {
                  if (typeof(Storage) !== 'undefined') {
                    localStorage.previousfirstname = firstname_entered;
                  }
                  alert("Invalid first name: " + firstname_entered);
                }
              }
              catch (exc) {
                console.log("error encountered at first name selection: " + exc);
              }

              if (typeof(Storage) !== 'undefined') {
                if (!localStorage.firstnameAsked) {
                  localStorage.firstnameAsked = 0;
                }
                localStorage.firstnameAsked = Number(localStorage.firstnameAsked) + 1;
                if (localStorage.firstname) {
                  console.log("new firstname: " + localStorage.firstname);
                  document.getElementById('form_firstname_id').value = localStorage.firstname;
                }
                else if ((localStorage.gamesok) && (Number(localStorage.gamesok) >= 100)) {
                  // modal_mode unchanged and form not submitted waiting for proper user input
                  return false; // do not close the modal
                }
              }
              setTimeout("submitForm();", 444);

              modal_mode = -1;
              return true; // close the modal

            }

            else if (modal_mode == 2) {

              setTimeout("showPossibleCodesButtonClick(false, -1, true);", 444);
              // (same effect: setTimeout("document.getElementById('showPossibleCodesButton').click();", 444);)

              modal_mode = -1;
              return true; // close the modal
            }

            // else (modal_mode >= 3)
            modal_mode = -1;
            return true; // close the modal
            // return false; // nothing happens

          }
      });
      /* // add a button
      modal.addFooterBtn('OK', 'tingle-btn tingle-btn--primary', function() {
        // here goes some logic
        modal.close();
      }); */

    </script>

    <iframe style='display:none;' name='my_frame'>Your browser does not support iframes!</iframe> <!-- suppress style='display:none;' to see the form's response -->
    <form  style='display:none;' id='my_form' target='my_frame' action='https://script.google.com/macros/s/AKfycbwHJh1Tz7idd8VQJNdWIqWd-6jMxInhRtqY_O96NN7OvEKiY_ox/exec'>

      playerid: <input id='form_playerid_id' name='playerid' type='text' value='-'><br>
      firstname: <input id='form_firstname_id' name='firstname' type='text' value='-'><br>

      nbcolumns: <input id='form_nbcolumns_id' name='nbcolumns' type='text' value='-'><br>
      score: <input id='form_score_id' name='score' type='text' value='-'><br>
      attempts: <input id='form_attempts_id' name='attempts' type='text' value='-'><br>
      time: <input id='form_time_id' name='time' type='text' value='-'><br>
      perfs: <input id='form_perfs_id' name='perfs' type='text' value='-'><br>
      nbuknperfs: <input id='form_nbuknperfs_id' name='nbuknperfs' type='text' value='-'><br>
      help: <input id='form_help_id' name='help' type='text' value='-'><br>

      gamesok: <input id='form_gamesok_id' name='gamesok' type='text' value='-'><br>
      deltagames: <input id='form_deltagames_id' name='deltagames' type='text' value='-'><br>

      country: <input id='form_country_id' name='country' type='text' value='-'><br>
      region: <input id='form_region_id' name='region' type='text' value='-'><br>
      zip: <input id='form_zip_id' name='zip' type='text' value='-'><br>
      city: <input id='form_city_id' name='city' type='text' value='-'><br>
      geoloc: <input id='form_geoloc_id' name='geoloc' type='text' value='-'><br>
      timezone: <input id='form_timezone_id' name='timezone' type='text' value='-'><br>
      latitude: <input id='form_latitude_id' name='latitude' type='text' value='-'><br>
      longitude: <input id='form_longitude_id' name='longitude' type='text' value='-'><br>
      ipaddress: <input id='form_ipaddress_id' name='ipaddress' type='text' value='-'><br>

      platform: <input id='form_platform_id' name='platform' type='text' value='-'><br> <!-- OS -->
      browserlanguage: <input id='form_browserlanguage_id' name='browserlanguage' type='text' value='-'><br> <!-- Browser language -->
      useragent: <input id='form_useragent_id' name='useragent' type='text' value='-'><br> <!-- Browser (more or less) -->
      href: <input id='form_href_id' name='href' type='text' value='-'><br>
      formsubmitdate: <input id='form_formsubmitdate_id' name='formsubmitdate' type='text' value='-'><br>
      debuginfo: <input id='form_debuginfo_id' name='debuginfo' type='text' value='-'><br>

      list: <input id='form_list_id' name='list' type='text' value='-'><br>

      rankings: <input id='form_rankings_id' name='rankings' type='text' value='-'><br>

    </form>

    <form  style='display:none;' id='my_all_scripts_loaded_form' target='my_frame' action='https://ALL_SCRIPTS_LOADED'>
    </form>

    <script>

      let loaded_sizes = new Array(3);
      loaded_sizes[0] = 105000; // game.html ~ 105KB
      loaded_sizes[1] = 105000; // GameSolver.js ~ 105KB (state: 1)
      loaded_sizes[2] = 305000; // SuperMasterMind.js ~ 305KB  (state: 2)
      function getGlobalProgress(progress, state) {
        if ((progress < 0) || (progress > 1)) { // error case
          return 0;
        }
        let sum_loaded_sizes = loaded_sizes[0] + loaded_sizes[1] + loaded_sizes[2];

        if (state == 0) {
          let percent_min = 0;
          let percent_max = 100 * loaded_sizes[0] / sum_loaded_sizes;
          return Math.min(100, Math.round(percent_min + progress * (percent_max - percent_min)));
        }
        else if (state == 1) {
          let percent_min = 100 * loaded_sizes[0] / sum_loaded_sizes;
          let percent_max = 100 * (loaded_sizes[0]+loaded_sizes[1]) / sum_loaded_sizes;
          return Math.min(100, Math.round(percent_min + progress * (percent_max - percent_min)));
        }
        else if (state == 2) {
          let percent_min = 100 * (loaded_sizes[0]+loaded_sizes[1]) / sum_loaded_sizes;
          let percent_max = 100;
          return Math.min(100, Math.round(percent_min + progress * (percent_max - percent_min)));
        }
        else {
          throw new Error("getGlobalProgress: invalid state: " + progress + ", " + state);
        }
      }
      var globalProgressForHTMLGame1 = getGlobalProgress(0.25 /* (rough value) */, 0);
      console.log("current progress: " + globalProgressForHTMLGame1 + "% (g)"); // !WARNING! -> this console text will be read by the android appli so shall not be modified
      if (globalProgressForHTMLGame1 > 0) {
        $("#game_loading_id").html("<img src='img/loading.gif' style='height:12%;'><br>Loading (" + globalProgressForHTMLGame1 + "%)"); // (not rem unit as no viewport! / duplicated code)
      }

      // String.replaceAll() method definition
      String.prototype.replaceAll = function(search, replacement) {
        let target = this;
        return target.replace(new RegExp(search, 'g'), replacement);
      };

      function capitalizeFirstLetters(str) {
        if (str.length == 0) {
          return "";
        }
        else if (str.length == 1) {
          return str.charAt(0).toUpperCase();
        }
        else {
          let res = str.toLowerCase();
          res = res.charAt(0).toUpperCase() + res.slice(1);

          let res2 = "";
          let index = res.indexOf('-');
          while ((index != -1) && (index+1 < res.length)) {
            res2 = res2 + res.substring(0, index+1) + res.charAt(index+1).toUpperCase();
            if (index+2 < res.length) {
              res = res.slice(index+2);
              index = res.indexOf('-');
            }
            else {
              res = "";
              index = -1;
            }
          }
          res2 = res2 + res;
          res = res2;
          res2 = "";
          index = res.indexOf(' ');
          while ((index != -1) && (index+1 < res.length)) {
            res2 = res2 + res.substring(0, index+1) + res.charAt(index+1).toUpperCase();
            if (index+2 < res.length) {
              res = res.slice(index+2);
              index = res.indexOf(' ');
            }
            else {
              res = "";
              index = -1;
            }
          }
          res2 = res2 + res;

          res = res2;
          res2 = "";
          index = res.indexOf("'");
          while ((index != -1) && (index+1 < res.length)) {
            res2 = res2 + res.substring(0, index+1) + res.charAt(index+1).toUpperCase();
            if (index+2 < res.length) {
              res = res.slice(index+2);
              index = res.indexOf("'");
            }
            else {
              res = "";
              index = -1;
            }
          }
          res2 = res2 + res;

          res2 = res2.replace(" D'"," d'");
          res2 = res2.replace(" Sur "," sur ");

          return res2;
        }
      }

      function getLocation() {
        switch(location.protocol) {
           case 'http:':
             return 'P1';
           case 'https:':
             return 'P1b';
           case 'file:':
             return 'P2';
           default:
             // (other protocols)
             return 'P3';
        }
      }

      function nbVowels(str)
      {
        var vowel_list = 'aeiouyAEIOUY'; // (accentuated vowels are not considered here)
        var vowel_count = 0;
        for (var i = 0 ; i < str.length ; i++) {
          if (vowel_list.indexOf(str[i]) !== -1) {
            vowel_count++;
          }
        }
        return vowel_count;
      }

      // ISO 3166-1 alpha-2 country codes
      let isoCountries = {
        'AF':'Afghanistan','AX':'Aland Islands','AL':'Albania','DZ':'Algeria','AS':'American Samoa','AD':'Andorra','AO':'Angola','AI':'Anguilla','AQ':'Antarctica','AG':'Antigua And Barbuda','AR':'Argentina','AM':'Armenia','AW':'Aruba','AU':'Australia','AT':'Austria','AZ':'Azerbaijan','BS':'Bahamas','BH':'Bahrain','BD':'Bangladesh','BB':'Barbados','BY':'Belarus','BE':'Belgium','BZ':'Belize','BJ':'Benin','BM':'Bermuda','BT':'Bhutan','BO':'Bolivia','BA':'Bosnia And Herzegovina','BW':'Botswana','BV':'Bouvet Island','BR':'Brazil','IO':'British Indian Ocean Territory','BN':'Brunei Darussalam','BG':'Bulgaria','BF':'Burkina Faso','BI':'Burundi','KH':'Cambodia','CM':'Cameroon','CA':'Canada','CV':'Cape Verde','KY':'Cayman Islands','CF':'Central African Republic','TD':'Chad','CL':'Chile','CN':'China','CX':'Christmas Island','CC':'Cocos (Keeling) Islands','CO':'Colombia','KM':'Comoros','CG':'Congo','CD':'Congo, Democratic Republic','CK':'Cook Islands','CR':'Costa Rica','CI':'Cote D\'Ivoire','HR':'Croatia','CU':'Cuba','CY':'Cyprus','CZ':'Czech Republic','DK':'Denmark','DJ':'Djibouti','DM':'Dominica','DO':'Dominican Republic','EC':'Ecuador','EG':'Egypt','SV':'El Salvador','GQ':'Equatorial Guinea','ER':'Eritrea','EE':'Estonia','ET':'Ethiopia','FK':'Falkland Islands (Malvinas)','FO':'Faroe Islands','FJ':'Fiji','FI':'Finland','FR':'France','GF':'French Guiana','PF':'French Polynesia','TF':'French Southern Territories','GA':'Gabon','GM':'Gambia','GE':'Georgia','DE':'Germany','GH':'Ghana','GI':'Gibraltar','GR':'Greece','GL':'Greenland','GD':'Grenada','GP':'Guadeloupe','GU':'Guam','GT':'Guatemala','GG':'Guernsey','GN':'Guinea','GW':'Guinea-Bissau','GY':'Guyana','HT':'Haiti','HM':'Heard Island & Mcdonald Islands','VA':'Holy See (Vatican City State)','HN':'Honduras','HK':'Hong Kong','HU':'Hungary','IS':'Iceland','IN':'India','ID':'Indonesia','IR':'Iran, Islamic Republic Of','IQ':'Iraq','IE':'Ireland','IM':'Isle Of Man','IL':'Israel','IT':'Italy','JM':'Jamaica','JP':'Japan','JE':'Jersey','JO':'Jordan','KZ':'Kazakhstan','KE':'Kenya','KI':'Kiribati','KR':'Korea','KW':'Kuwait','KG':'Kyrgyzstan','LA':'Lao People\'s Democratic Republic','LV':'Latvia','LB':'Lebanon','LS':'Lesotho','LR':'Liberia','LY':'Libyan Arab Jamahiriya','LI':'Liechtenstein','LT':'Lithuania','LU':'Luxembourg','MO':'Macao','MK':'Macedonia','MG':'Madagascar','MW':'Malawi','MY':'Malaysia','MV':'Maldives','ML':'Mali','MT':'Malta','MH':'Marshall Islands','MQ':'Martinique','MR':'Mauritania','MU':'Mauritius','YT':'Mayotte','MX':'Mexico','FM':'Micronesia, Federated States Of','MD':'Moldova','MC':'Monaco','MN':'Mongolia','ME':'Montenegro','MS':'Montserrat','MA':'Morocco','MZ':'Mozambique','MM':'Myanmar','NA':'Namibia','NR':'Nauru','NP':'Nepal','NL':'Netherlands','AN':'Netherlands Antilles','NC':'New Caledonia','NZ':'New Zealand','NI':'Nicaragua','NE':'Niger','NG':'Nigeria','NU':'Niue','NF':'Norfolk Island','MP':'Northern Mariana Islands','NO':'Norway','OM':'Oman','PK':'Pakistan','PW':'Palau','PS':'Palestinian Territory, Occupied','PA':'Panama','PG':'Papua New Guinea','PY':'Paraguay','PE':'Peru','PH':'Philippines','PN':'Pitcairn','PL':'Poland','PT':'Portugal','PR':'Puerto Rico','QA':'Qatar','RE':'Reunion','RO':'Romania','RU':'Russian Federation','RW':'Rwanda','BL':'Saint Barthelemy','SH':'Saint Helena','KN':'Saint Kitts And Nevis','LC':'Saint Lucia','MF':'Saint Martin','PM':'Saint Pierre And Miquelon','VC':'Saint Vincent And Grenadines','WS':'Samoa','SM':'San Marino','ST':'Sao Tome And Principe','SA':'Saudi Arabia','SN':'Senegal','RS':'Serbia','SC':'Seychelles','SL':'Sierra Leone','SG':'Singapore','SK':'Slovakia','SI':'Slovenia','SB':'Solomon Islands','SO':'Somalia','ZA':'South Africa','GS':'South Georgia And Sandwich Isl.','ES':'Spain','LK':'Sri Lanka','SD':'Sudan','SR':'Suriname','SJ':'Svalbard And Jan Mayen','SZ':'Swaziland','SE':'Sweden','CH':'Switzerland','SY':'Syrian Arab Republic','TW':'Taiwan','TJ':'Tajikistan','TZ':'Tanzania','TH':'Thailand','TL':'Timor-Leste','TG':'Togo','TK':'Tokelau','TO':'Tonga','TT':'Trinidad And Tobago','TN':'Tunisia','TR':'Turkey','TM':'Turkmenistan','TC':'Turks And Caicos Islands','TV':'Tuvalu','UG':'Uganda','UA':'Ukraine','AE':'United Arab Emirates','GB':'United Kingdom','US':'United States','UM':'United States Outlying Islands','UY':'Uruguay','UZ':'Uzbekistan','VU':'Vanuatu','VE':'Venezuela','VN':'Viet Nam','VG':'Virgin Islands, British','VI':'Virgin Islands, U.S.','WF':'Wallis And Futuna','EH':'Western Sahara','YE':'Yemen','ZM':'Zambia','ZW':'Zimbabwe'
      };

      function getCountryName(countryCode) {
        if ((typeof countryCode == 'undefined') || (countryCode == undefined) || (countryCode == null)) {
          return '-';
        }
        let prop = countryCode.toUpperCase();
        if (isoCountries.hasOwnProperty(prop)) {
          return isoCountries[prop];
        }
        else {
          return countryCode;
        }
      }

      function getHTMLListOfCountries() {
        let str = "";
        for (let prop in isoCountries) {
          if (isoCountries.hasOwnProperty(prop)) {
            let countrycode = prop;
            let countryname = isoCountries[prop];
            str = str + "<option value=\\\"" + countrycode + "\\\">" + countryname + "</option>";
          }
        }
        return str;
      }

      function isCorrect(str) {
        if ( (str.toLowerCase().indexOf('sherlo') != -1) // (Sherlock)
             || (str.toLowerCase().indexOf('aaa') != -1)
             || (str.toLowerCase().indexOf('bbb') != -1)
             || (str.toLowerCase().indexOf('ccc') != -1)
             || (str.toLowerCase().indexOf('ddd') != -1)
             || (str.toLowerCase().indexOf('eee') != -1)
             || (str.toLowerCase().indexOf('fff') != -1)
             || (str.toLowerCase().indexOf('ggg') != -1)
             || (str.toLowerCase().indexOf('hhh') != -1)
             || (str.toLowerCase().indexOf('iii') != -1)
             || (str.toLowerCase().indexOf('jjj') != -1)
             || (str.toLowerCase().indexOf('kkk') != -1)
             || (str.toLowerCase().indexOf('lll') != -1)
             || (str.toLowerCase().indexOf('mmm') != -1)
             || (str.toLowerCase().indexOf('nnn') != -1)
             || (str.toLowerCase().indexOf('ooo') != -1)
             || (str.toLowerCase().indexOf('ppp') != -1)
             || (str.toLowerCase().indexOf('qqq') != -1)
             || (str.toLowerCase().indexOf('rrr') != -1)
             || (str.toLowerCase().indexOf('sss') != -1)
             || (str.toLowerCase().indexOf('ttt') != -1)
             || (str.toLowerCase().indexOf('uuu') != -1)
             || (str.toLowerCase().indexOf('vvv') != -1)
             || (str.toLowerCase().indexOf('www') != -1)
             || (str.toLowerCase().indexOf('xxx') != -1)
             || (str.toLowerCase().indexOf('yyy') != -1)
             || (str.toLowerCase().indexOf('zzz') != -1)
             || (str.toLowerCase().indexOf('bastard') != -1)
             || (str.toLowerCase().indexOf('fuck') != -1)
             || (str.toLowerCase().endsWith("bite"))
             || (str.toLowerCase().indexOf('noname') != -1)
             || (str.toLowerCase().indexOf('unknown') != -1)
             || (str.toLowerCase().indexOf('myname') != -1)
             || (str.toLowerCase().indexOf('nobody') != -1)
             || (str.toLowerCase().indexOf('noone') != -1)
             || (str.toLowerCase().indexOf('dummy') != -1)
             || (str.toLowerCase().indexOf('empty') != -1)
             || (str.toLowerCase().indexOf('-') == 0)
             || (str.toLowerCase().lastIndexOf('-') == str.length - 1)
             || (str.toLowerCase().indexOf('--') != -1)
             || (str.toLowerCase().indexOf('_') != -1)
             || (nbVowels(str) == 0)
             || (nbVowels(str) == str.length) ) {
          return false;
        }
        return true;
      }

      if (typeof(Storage) !== 'undefined') {
        if (localStorage.firstname && (!isCorrect(localStorage.firstname))) {
          localStorage.previousfirstname = localStorage.firstname;
          localStorage.removeItem('firstname'); // localStorage.firstname
        }
      }

      function str_from_jqxhr(jqxhr) { // (jqxhr: XMLHTTPRequest)
        try {
          let str = "jqxhr={";
          try {
            /* Status:
               200: "OK"
               403: "Forbidden"
               404: "Page not found"
               ... */
            str = str + "status:" + jqxhr.status;
            str = str + ",statusText:" + jqxhr.statusText;
            /* readyState holds the status of the XMLHttpRequest:
               0: request not initialized
               1: server connection established
               2: request received
               3: processing request
               4: request finished and response is ready */
            str = str + ",readyState:" + jqxhr.readyState;
          }
          catch (exc) {
            str = str + "?";
          }
          str = str + "}";
          return str;
        }
        catch (exc) {
          return "jqxhr=?";
        }
      }

      // Interesting links about JSONP:
      // - https://en.wikipedia.org/wiki/Same-origin_policy and https://www.getfilecloud.com/blog/using-jsonp-for-cross-domain-requests/ (JSONP usage & safety)
      // - https://ctrlq.org/code/20197-jquery-ajax-call-google-script (usage of JSONP to avoid "Cross Origin" issues)
      //   => "JSONP" to be replaced by "CORS" in the future when fully supported, which is safer.
      function submitForm(formStr = "", skipErrorDisplay = false) {

        if (globalErrorStatus > 0) { // skip form submission when a basic global error occurred
          console.log("(form submission skipped)");
          return;
        }

        let my_form_url = document.getElementById("my_form").action + '?';
        if (formStr == "") { // Nominal case
          // console.log(JSON.stringify($("#my_form").serializeArray()));
          let elements = document.getElementById("my_form").elements;
          for (let i = 0, element; element = elements[i++];) {
            my_form_url = my_form_url + element.name + '=' + element.value + '&';
          }
          if (abbreviateScores) {
            my_form_url = my_form_url + 'compressrsp=' + abbreviateScores + '&';
          }
          if (mobileMode) {
            my_form_url = my_form_url + 'mobilemode=' + mobileMode + '&';
          }
        }
        else { // Specific case
          my_form_url = my_form_url + 'form_str=' + formStr + '&';
        }
        my_form_url = my_form_url + 'k=' + Math.floor(Math.random()*9999999999+1) + '&';
        my_form_url = my_form_url + 'my_callback_fct=handle_rsp';

        // Avoid request blocking by Chrome for the following reason:
        // "Resource requests whose URLs contained both removed whitespace (`\n`, `\r`, `\t`) characters and less-than characters (`<`) are blocked.
        //  Please remove newlines and encode less-than characters from places like element attribute values in order to load these resources.
        //  See https://www.chromestatus.com/feature/5735596811091968 for more details."
        my_form_url = my_form_url.replaceAll("\n"," ");
        my_form_url = my_form_url.replaceAll("\r","");
        my_form_url = my_form_url.replaceAll("\t"," ");
        // my_form_url = my_form_url.replaceAll("<","_");
        // my_form_url = my_form_url.replaceAll(">","_"); // (symmetrical replace applied)

        // console.log(my_form_url);
        // Submit form
        console.log("(jQuery.ajax get/jsonp" + ((formStr == "") ? "" : " for a specific case") + ")");
        debug_game_state = 50;
        jQuery.ajax({
          crossDomain: true,
          url: my_form_url,
          method: "GET",
          dataType: "jsonp",
          timeout: 40000 // 40 seconds
        })
        .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
          debug_game_state = 51;
          try {
            if (jqxhr.status != 200) { // Note: covers the 404 status which corresponds to the error "Loading failed for the <script> with source https://..."
              console.log(("script submission failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());

              jQuery.ajax({
                crossDomain: true,
                url: my_form_url,
                method: "GET",
                dataType: "jsonp",
                timeout: 40000 // 40 seconds
              })
              .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
                try {
                  if (jqxhr.status != 200) { // Note: covers the 404 status which corresponds to the error "Loading failed for the <script> with source https://..."
                    console.log(("script submission retry failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
                  } // else: systematic parse error (with 200 status) is ignored
                  if ((formStr == "") && (!skipErrorDisplay)) {
                    alert("Oops... a network error occurred!");
                  }
                }
                catch (exc) {
                  console.log(("script submission retry failure (abnormal case): " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
                }
              });
            } // else: systematic parse error (with 200 status) is ignored
          }
          catch (exc) {
            console.log(("script submission failure (abnormal case): " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
          }
          debug_game_state = 52;
        });

        // document.getElementById('my_form').submit();
        // $("#my_form").submit();
      }

      function getChromeVersion() { // return -1 if N.A. / issue: covers also MS Edge!
        try {
          var raw = navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);
          return (raw ? parseInt(raw[2], 10) : -1);
        }
        catch (exc) {
          return -1;
        }
      }

      // Temporary error handling (from this point in this file to simplify / will be overwritten later)
      function tmp_game_onerror(errorStr, errStack) {
        submitForm("***** GAME ERROR ***** (" + html_compatibility_game_version + "): " + errorStr + " / " + errStack + " in " + userAgentStr, true);
      }
      window.onerror = tmp_game_onerror;
      window.onmessageerror = tmp_game_onerror;
      // Promise rejection handling
      window.onunhandledrejection = function(evt) {
        var evt_str = "-";
        try {
          evt_str = JSON.stringify(evt).substring(0, 101).trim();
        }
        catch (exc) {}
        var evt_promise_str = "-";
        try {
          evt_promise_str = JSON.stringify(evt.promise).substring(0, 101).trim();
        }
        catch (exc) {}
        var extra_debug_info = "-";
        if (localStorage.firstname) {
          extra_debug_info = localStorage.firstname;
        }
        else if (localStorage.playerid) {
          extra_debug_info = localStorage.playerid;
        }
        try {
          extra_debug_info = extra_debug_info + " gameOnGoing=" + gameOnGoing() + ", currentAttemptNumber=" + currentAttemptNumber + ", gameWon=" + gameWon;
        }
        catch (exc) {}
        let skip_undefined_errors = ((evt == undefined) || ((evt.reason == undefined) && (evt.promise == undefined)));
        if (!skip_undefined_errors) {
          submitForm("***** GAME UNHANDLEDREJECTION ERROR ***** (" + html_compatibility_game_version + "): event: " + evt + ", " + evt_str + " / reason: " + evt.reason + " / promise: " + evt.promise + ", " + evt_promise_str + " / debug: " + nbGamesPlayed + ", " + nbGamesPlayedAndWon + ", " + debug_game_state + ", " + debug_on_unload + " for " + extra_debug_info + " in " + userAgentStr, true);
        }
      };
      window.onrejectionhandled = function(evt) {
        var evt_str = "-";
        try {
          evt_str = JSON.stringify(evt).substring(0, 101).trim();
        }
        catch (exc) {}
        var evt_promise_str = "-";
        try {
          evt_promise_str = JSON.stringify(evt.promise).substring(0, 101).trim();
        }
        catch (exc) {}
        var extra_debug_info = "-";
        if (localStorage.firstname) {
          extra_debug_info = localStorage.firstname;
        }
        else if (localStorage.playerid) {
          extra_debug_info = localStorage.playerid;
        }
        try {
          extra_debug_info = extra_debug_info + " gameOnGoing=" + gameOnGoing() + ", currentAttemptNumber=" + currentAttemptNumber + ", gameWon=" + gameWon;
        }
        catch (exc) {}
        let skip_undefined_errors = ((evt == undefined) || ((evt.reason == undefined) && (evt.promise == undefined)));
        if (!skip_undefined_errors) {
          submitForm("***** GAME REJECTIONHANDLED ERROR ***** (" + html_compatibility_game_version + "): event: " + evt + ", " + evt_str + " / reason: " + evt.reason + " / promise: " + evt.promise + ", " + evt_promise_str + " / debug: " + nbGamesPlayed + ", " + nbGamesPlayedAndWon + ", " + debug_game_state + ", " + debug_on_unload + " for " + extra_debug_info + " in " + userAgentStr, true);
        }
      };

      var playerid_prefix = "ID/";
      function handle_rsp_delayed(e) {
        debug_game_state = 80;
        try {
          if ( (e !== undefined) && (e != null)
               && (typeof e.parameter !== 'undefined') && (e.parameter != undefined) && (e.parameter != null)
               && (typeof e.parameter.playerid !== 'undefined')
               && (typeof e.rsp_cd == 'undefined')
               && (typeof e.parameter.rankings !== 'undefined') && (e.parameter.rankings.length > 10) ) {
            var rsp_rankings_str = JSON.stringify(e.parameter.rankings).replaceAll("^\"|\"$", ""); // (suppress leading and ending double quotes)
            console.log("1: " + rsp_rankings_str);
            rsp_rankings_str = rsp_rankings_str.replaceAll("width:TABLE_WIDTH", "width:" + scoresTableWidthStr);
            rsp_rankings_str = rsp_rankings_str.replaceAll("font-size:HEADER_FTZ", "font-size:2.7vh");
            rsp_rankings_str = rsp_rankings_str.replaceAll("font-size:FTZ", "font-size:" + scoresFontSizeStr);
            rsp_rankings_str = rsp_rankings_str.replaceAll("<td>", "<td style='border:1px solid black;margin:2px;padding:2px;text-align:center;font-weight:bold;'>"); // actual <td> syntax is applied
            rsp_rankings_str = rsp_rankings_str.replace(/[\[]/g, "<td style='border:1px solid black;margin:2px;padding:2px;text-align:center;font-weight:bold;'>"); // actual <td> syntax is applied: "[" -> "<td ...>"
            rsp_rankings_str = rsp_rankings_str.replace(/[\]]/g, "</td>"); // actual </td> syntax is applied: "]" -> "</td>"
            rsp_rankings_str = rsp_rankings_str.replaceAll("<s>", "<small>"); // "<s>" -> "<small>"
            rsp_rankings_str = rsp_rankings_str.replaceAll("</s>", "</small>"); // "</s>" -> "</small>"
            rsp_rankings_str = rsp_rankings_str.replace(/(\([0-9]+\))/g, "<font color=#555555>$1</font>"); // apply some color changes
            rsp_rankings_str = rsp_rankings_str.replace(/(\|[0-9]+)/g, "<font color=#555555>$1</font>"); // apply some color changes
            // console.log("2: " + rsp_rankings_str);
            // Rk: top scores are always displayed, even if current game score is not in them
            try {
              modal_mode = 2;
              // set modal content
              modal.setContent("<div style='-webkit-touch-callout: none; /* iOS Safari */ -webkit-user-select: none; /* Safari */ -khtml-user-select: none; /* Konqueror HTML */ -moz-user-select: none; /* Firefox */ -ms-user-select: none; /* Internet Explorer/Edge */ user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */'>"
                               + rsp_rankings_str
                               + "</div>");
              // open modal
              modal.open();
            }
            catch (exc) {
              throw new Error("modal error (" + modal_mode + "): " + exc + ": " + exc.stack);
            }
          }
          else {
            if ((e == undefined) || (e == null)) {
              console.log('rsp_cd: ?');
            }
            else if (typeof e.rsp_cd !== 'undefined') {
              console.log('rsp_cd: ' + JSON.stringify(e.rsp_cd));
            }
            else {
              console.log('rsp_cd: ?');
            }
          }
        }
        catch (exc) {
          throw new Error("handle_rsp_delayed error: " + exc + ": " + exc.stack);
        }
        debug_game_state = 81;
      }
      function handle_rsp(e) {
        console.log("(handle_rsp)");

        var score_display_time = 4444; // (see blinking time)
        if (mobileMode) {
          score_display_time = 1444; // (no blinking)
        }

        var time_to_wait = 44;
        var time_diff = new Date().getTime() - store_time;
        if (time_diff < 0) { // (invalid case)
          time_to_wait = 44;
        }
        else if (time_diff < score_display_time) {
          time_to_wait = score_display_time - time_diff;
        }
        else {
          time_to_wait = 44; // (no time to wait, form submission was long enough)
        }
        console.log("(time_diff=" + time_diff + ", time_to_wait=" + time_to_wait + ")");
        setTimeout("handle_rsp_delayed(" + JSON.stringify(e) + ");", time_to_wait);
      }

      var globalProgressForHTMLGame2 = getGlobalProgress(0.5 /* (rough value) */, 0);
      console.log("current progress: " + globalProgressForHTMLGame2 + "% (g)"); // !WARNING! -> this console text will be read by the android appli so shall not be modified
      if (globalProgressForHTMLGame2 > 0) {
        $("#game_loading_id").html("<img src='img/loading.gif' style='height:12%;'><br>Loading (" + globalProgressForHTMLGame2 + "%)"); // (not rem unit as no viewport! / duplicated code)
      }

      var last_location_data_used = null;
      var id_of_last_location_data_used = -1;
      var html_geoloc_next_gamesok = -100;

      function reformatLocationValue(x) {
        if ((typeof x == 'undefined') || (x == undefined) || (x == null)) {
          return '-';
        }
        else {
          return String(x).trim();
        }
      }

      function isLocationDataValid(data_p) {
        if ((typeof data_p == 'undefined') || (data_p == undefined) ||  (data_p == null)) {
          return false;
        }
        if ( (typeof data_p.latitude != 'undefined') && (data_p.latitude != undefined) && (data_p.latitude != null)
             && (typeof data_p.longitude != 'undefined') && (data_p.longitude != undefined)  && (data_p.longitude != null)
             && ((String(data_p.latitude).indexOf('.') != -1) || (String(data_p.longitude).indexOf('.') != -1))
             && ((typeof data_p.country_name != 'undefined') && (data_p.country_name != undefined) && (data_p.country_name != null) && (data_p.country_name.length >= 3))
             && ((typeof data_p.city != 'undefined') && (data_p.city != undefined) && (data_p.city != null) && (data_p.city.length >= 2)) // (redundant lines)
             && ((typeof data_p.ip != 'undefined') && (data_p.ip != undefined) && (data_p.ip != null) && (String(data_p.ip).trim().length >= 7 /* 0.0.0.0 */)) ) {
          return true;
        }
        return false;
      }

      let very_fine_location_data = null;
      function HTML_geolocation_success(position) {
        let latitude = position.coords.latitude;
        let longitude = position.coords.longitude;
        let accuracy = position.coords.accuracy; // (in meters)
        console.log("HTML geolocation:");
        console.log(" latitude: " + latitude);
        console.log(" longitude: " + longitude);
        console.log(" accuracy: " + accuracy);
        let GEOCODING_API_URL = "https://www.mapquestapi.com/geocoding/v1/reverse?outFormat=json&location=" + latitude + "," + longitude + "&key=dCKxMASlEZayTGGw5SBfd2bGMSCUuP60";
        debug_game_state = 10;
        $.getJSON(GEOCODING_API_URL)
        .done(function(location) {
          debug_game_state = 11;
          try {
            if (location.info.statuscode == "0") { // geocoding API success
              let country = getCountryName(String(location.results[0].locations[0].adminArea1).trim());
              let region = String(location.results[0].locations[0].adminArea3).trim();
              let city = String(location.results[0].locations[0].adminArea5).trim();
              let zip = String(location.results[0].locations[0].postalCode).trim();
              console.log(location);
              console.log(" country: " + country);
              console.log(" region: " + region);
              console.log(" city: " + city);
              console.log(" zip: " + zip);
              console.log(" address: " + String(location.results[0].locations[0].street).trim());

              // country + region + city + firstname are used below to identify unique players
              var sum = 0;
              for (var i = 0; i < country.length; i++) {
                sum = sum + country.charCodeAt(i);
              }
              for (var i = 0; i < region.length; i++) {
                sum = sum + region.charCodeAt(i);
              }
              for (var i = 0; i < city.length; i++) {
                sum = sum + city.charCodeAt(i);
              }
              var sum2 = 0;
              if (localStorage.firstname) {
                for (var i = 0; i < localStorage.firstname.length; i++) {
                  sum2 = sum2 + localStorage.firstname.charCodeAt(i);
                }
              }
              var inferred_ip_address = "0." + String(sum2 % 999) + "." + String(Math.floor(sum / 99) % 999) + "." + String(sum % 999);

              very_fine_location_data = { latitude: reformatLocationValue(latitude),
                                          longitude: reformatLocationValue(longitude),
                                          accuracy: accuracy,
                                          country_name: reformatLocationValue(country),
                                          region: reformatLocationValue(region),
                                          city: reformatLocationValue(city),
                                          postal: zip,
                                          ip: inferred_ip_address,
                                          vf_date: new Date() };
              if (isLocationDataValid(very_fine_location_data)) {
                // Reinit last_location_data_used to have it consistent with below localStorage.xxx values
                last_location_data_used = null;
                id_of_last_location_data_used = -1;

                localStorage.latitude = reformatLocationValue(latitude);
                localStorage.longitude = reformatLocationValue(longitude);
                localStorage.accuracy = accuracy;
                localStorage.countryname = reformatLocationValue(country);
                localStorage.region = reformatLocationValue(region);
                localStorage.city = reformatLocationValue(city);
                localStorage.ip = inferred_ip_address;
                localStorage.vf_date = new Date();
                localStorage.location_id = nbLocationURLs + 10;
                localStorage.html_geoloc_status = "ok";
              }
              else {
                console.log("HTML geolocation error: invalid location values");
                localStorage.html_geoloc_status = "ok-invalid";
              }
            }
            else {
              console.log("HTML geolocation error: status: " + location.status);
              localStorage.html_geoloc_status = "nok-2/" + location.status;
            }
          }
          catch (exc) {
            console.log("HTML geolocation error: " + exc);
            localStorage.html_geoloc_status = "nok-3/" + exc;
          }
          debug_game_state = 12;
        })
        .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
          debug_game_state = 13;
          console.log(("HTML geolocation failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim());
          localStorage.html_geoloc_status = "nok-4";
          debug_game_state = 14;
        });
      } // HTML_geolocation_success

      function HTML_geolocation_error(error) {
        let error_str = "?";
        switch(error.code) {
          case error.PERMISSION_DENIED:
            if (!localStorage.html_geoloc_denied) {
              localStorage.html_geoloc_denied = 0;
            }
            localStorage.html_geoloc_denied = Number(localStorage.html_geoloc_denied) + 1;
            error_str = "user denied the request for geolocation/" + localStorage.html_geoloc_denied + "x";
            break;
          case error.POSITION_UNAVAILABLE:
            error_str = "location information is unavailable";
            break;
          case error.TIMEOUT:
            error_str = "the request to get user location timed out";
            break;
          case error.UNKNOWN_ERROR:
            error_str = "an unknown error occurred";
            break;
        }
        console.log("HTML geolocation error: " + error_str);
        localStorage.html_geoloc_status = "nok-5/" + error_str;
      } // HTML_geolocation_error

      let my_position = null;
      function attempt_HTML_geolocation() {
        if (typeof(Storage) !== 'undefined') {
          localStorage.html_geoloc_status = "run";
          if (navigator.geolocation) {
            // Subject to user acceptance
            // Version 1:
            // navigator.geolocation.getCurrentPosition(HTML_geolocation_success, HTML_geolocation_error);
            // Version 2 (support of location updates & more precise than getCurrentPosition() because several iterations are made):
            let my_geolocation = navigator.geolocation.watchPosition(
                function (position) { // success callback (called N times)
                  my_position = {coords: {latitude: position.coords.latitude, longitude: position.coords.longitude, accuracy: position.coords.accuracy}};
                  console.log('HTML geolocation iteration (latitude: ' + position.coords.latitude + ', ' + 'longitude: ' + position.coords.longitude + ', ' + 'accuracy: ' + position.coords.accuracy + ")");
                },
                HTML_geolocation_error, // error callback
                {
                  maximumAge: 250, // (do not use cache for long)
                  enableHighAccuracy: true
                }
            );
            setTimeout(function() {
                navigator.geolocation.clearWatch(my_geolocation); // stop further HTML geolocation iterations (i.e. further calls to watchPosition())
                console.log("stop HTML geolocation iterations");
                if (my_position != null) { // (at least one HTML geolocation success during the iterations)
                  HTML_geolocation_success(my_position); // (use last success's position)
                }
              },
              8888 // stop further HTML geolocation iterations after 8 seconds
            );
          }
          else {
            console.log("HTML geolocation error: geolocation is not supported by the browser");
            localStorage.html_geoloc_status = "nok-6";
          }
        }
      }

      var last_game_cnt = -1;
      function store_player_info(game_cnt, nbcolumns, score, attempts, timestr, perfs, nbuknperfs, help, gamestr) {
        debug_game_state = 100;
        try {

          if (game_cnt == last_game_cnt) { // At most one storage per game
            return;
          }
          last_game_cnt = game_cnt;
          store_time = new Date().getTime();

          let gamesok = -1;
          let deltagames = -1;
          if (typeof(Storage) !== 'undefined') {

            if (!localStorage.gamesok) {
              localStorage.gamesok = 0;
            }
            localStorage.gamesok = Number(localStorage.gamesok) + 1;
            if ( ((localStorage.gamesok <= 1000) && ((localStorage.gamesok % 100) == 0)) || ((localStorage.gamesok % 500) == 0) ) {
              alert("It's your " + localStorage.gamesok + "th game!");
            }
            gamesok = Number(localStorage.gamesok);

            if ((gamesok >= 150) && (!localStorage.firstname)) { // No interest for sharing results
              if ((gamesok % 10) != 1) { // first name will no longer be asked / this condition will let pass some odd gamesok values rarely
                return;
              }
              if (nbcolumns == 3) {
                return;
              }
            }
            if (localStorage.skip_storing) {
              return;
            }

            switch (nbcolumns) {

              case 3:
                if (!localStorage.nbgamesstarted3) {
                  localStorage.nbgamesstarted3 = 0;
                }
                if (!localStorage.nbgamesstarted3_ref) {
                  localStorage.nbgamesstarted3_ref = 0;
                }
                deltagames = localStorage.nbgamesstarted3 - localStorage.nbgamesstarted3_ref - 1;
                localStorage.nbgamesstarted3_ref = localStorage.nbgamesstarted3;
                break;
              case 4:
                if (!localStorage.nbgamesstarted4) {
                  localStorage.nbgamesstarted4 = 0;
                }
                if (!localStorage.nbgamesstarted4_ref) {
                  localStorage.nbgamesstarted4_ref = 0;
                }
                deltagames = localStorage.nbgamesstarted4 - localStorage.nbgamesstarted4_ref - 1;
                localStorage.nbgamesstarted4_ref = localStorage.nbgamesstarted4;
                break;
              case 5:
                if (!localStorage.nbgamesstarted5) {
                  localStorage.nbgamesstarted5 = 0;
                }
                if (!localStorage.nbgamesstarted5_ref) {
                  localStorage.nbgamesstarted5_ref = 0;
                }
                deltagames = localStorage.nbgamesstarted5 - localStorage.nbgamesstarted5_ref - 1;
                localStorage.nbgamesstarted5_ref = localStorage.nbgamesstarted5;
                break;
              case 6:
                if (!localStorage.nbgamesstarted6) {
                  localStorage.nbgamesstarted6 = 0;
                }
                if (!localStorage.nbgamesstarted6_ref) {
                  localStorage.nbgamesstarted6_ref = 0;
                }
                deltagames = localStorage.nbgamesstarted6 - localStorage.nbgamesstarted6_ref - 1;
                localStorage.nbgamesstarted6_ref = localStorage.nbgamesstarted6;
                break;

              case 7:
                if (!localStorage.nbgamesstarted7) {
                  localStorage.nbgamesstarted7 = 0;
                }
                if (!localStorage.nbgamesstarted7_ref) {
                  localStorage.nbgamesstarted7_ref = 0;
                }
                deltagames = localStorage.nbgamesstarted7 - localStorage.nbgamesstarted7_ref - 1;
                localStorage.nbgamesstarted7_ref = localStorage.nbgamesstarted7;
                break;

              default:
                console.log("Error: invalid nbcolumns in store_player_info(): " + nbcolumns);
                return;

            }

          }

          var geolocation_handler = {

            nb_JSON_queries_posted: 0,

            convertLocationData: function(data_p, locationId) {

              if (locationId == 1) {
                return data_p;
              }
              else if (locationId == 2) {
                /* ipinfodb.com response format:
                   - SUCCESS case:
                    statusCode	"OK"
                    statusMessage	""
                    ipAddress	"94.239.111.222"
                    countryCode	"FR"
                    countryName	"France"
                    regionName	"Ile-de-France"
                    cityName	"Paris"
                    zipCode	"75000"
                    latitude	"48.8534"
                    longitude	"2.3488"
                    timeZone	"+01:00"
                  - FAILURE case:
                    statusCode	"ERROR"
                    statusMessage	"Invalid IP Address."
                    ipAddress	"994.239.111.222"
                    countryCode	""
                    countryName	""
                    regionName	""
                    cityName	""
                    zipCode	""
                    latitude	"0"
                    longitude	"0"
                    timeZone	""
                */

                let converted_data = JSON.stringify(data_p);
                if ((typeof data_p.statusCode != 'undefined') && (typeof data_p.statusMessage != 'undefined') && (data_p.statusCode != "OK")) {
                  console.log("geolocation error in convertLocationData: " + locationId + ", " + data_p.statusCode + ", " + data_p.statusMessage);
                }

                // latitude -> latitude
                // longitude -> longitude
                // countryName -> country_name
                converted_data = converted_data.replace("\"countryName\":", "\"country_name\":");
                // regionName -> region
                converted_data = converted_data.replace("\"regionName\":", "\"region\":");
                // zipCode -> postal
                converted_data = converted_data.replace("\"zipCode\":", "\"postal\":");
                // cityName -> city
                converted_data = converted_data.replace("\"cityName\":", "\"city\":");
                // timeZone -> time_zone
                converted_data = converted_data.replace("\"timeZone\":", "\"time_zone\":");
                // ipAddress -> ip
                converted_data = converted_data.replace("\"ipAddress\":", "\"ip\":");

                return JSON.parse(converted_data);
              }
              else if (locationId == 3) {
                /* ipinfo.io response format:
                   - SUCCESS case:
                    ip	"444.444.444.444"
                    city	"xxx"
                    region	"xxx"
                    country	"US" as a country code
                    loc	"44.0000,44.0000"
                    org	"xxx"
                */

                let data = JSON.parse(JSON.stringify(data_p)); // clone/duplicate data_p into data (using JSON conversion and back)

                try {
                  // convert country code to country name
                  data.country = getCountryName(data.country);
                  // loc -> latitude
                  // loc -> longitude
                  let commma_idx = data.loc.indexOf(',');
                  if (commma_idx == -1) {
                    throw new Error("(commma_idx == -1)");
                  }
                  data.latitude = data.loc.substring(0,commma_idx);
                  data.longitude = data.loc.substring(commma_idx+1);
                }
                catch (e) {
                  console.log("geolocation error in convertLocationData: " + locationId + ", " + e);
                }

                let converted_data = JSON.stringify(data);

                // latitude -> latitude
                // longitude -> longitude
                // country -> country_name
                converted_data = converted_data.replace("\"country\":", "\"country_name\":");
                // region -> region
                // city -> city
                // ip -> ip

                return JSON.parse(converted_data);
              }
              else {
                throw new Error("convertLocationData: unexpected locationId value: " + locationId);
              }

            },

            setFormInfoWithValidLocationData: function(data_p, locationId, extraLocationInfo) {

              // Get location data
              // *****************

              if (!isLocationDataValid(data_p)) {
                throw new Error("setFormInfoWithValidLocationData: invalid location data: " + JSON.stringify(data_p) + ", " + locationId + ", " + extraLocationInfo);
              }

              let latitude = reformatLocationValue(data_p.latitude);
              let longitude = reformatLocationValue(data_p.longitude);
              let country = reformatLocationValue(data_p.country_name);
              let region = reformatLocationValue(data_p.region);
              let city = reformatLocationValue(data_p.city);
              let ipaddress = reformatLocationValue(data_p.ip);
              let zip = '-';
              if ((typeof data_p.postal != 'undefined') && (data_p.postal != undefined) && (data_p.postal != null) && (String(data_p.postal).trim().length >= 2)) {
                zip = String(data_p.postal).trim();
              }
              let timezone = '-';
              if ((typeof data_p.time_zone != 'undefined') && (data_p.time_zone != undefined) && (data_p.time_zone != null) && (String(data_p.time_zone).trim().length >= 2)) {
                if ((typeof data_p.time_zone.name != 'undefined') && (data_p.time_zone.name != undefined) && (data_p.time_zone.name != null) && (String(data_p.time_zone.name).trim().length >= 2)) {
                  timezone = String(data_p.time_zone.name).trim();
                }
                else {
                  timezone = String(data_p.time_zone).trim();
                }
              }

              // Manual updates
              // **************

              // Manual geolocation table corrections for particular IP addresses
              if ( (ipaddress.indexOf("176.130.42.") == 0) && (ipaddress.length <= 15) ) { // 176.130.42.* IPv4 addresses
                country = "France";
                region = "Alsace";
                city = "Munster";
              }

              // Manual conversions
              if (localStorage.playerid && (localStorage.playerid.indexOf("0G5V") == 0) && (region == "Illinois") && (city == "Naperville")) {
                country = "France";
                region = "Île-de-France";
                city = "Paris";
              }
              else if (localStorage.playerid && (localStorage.playerid.indexOf("0G5V") == 0) && (region == "California") && (city == "San Jose")) {
                country = "France";
                region = "Île-de-France";
                city = "Paris";
              }
              else if (localStorage.playerid && (localStorage.playerid.indexOf("0G5V") == 0) && (region == "Bayern") && (city == "Munich")) {
                country = "France";
                region = "Île-de-France";
                city = "Paris";
              }
              if (country == "Lao People's Democratic Republic") {
                country = "Laos";
              }
              if (country == "Venezuela, Bolivarian Republic of") {
                country = "Venezuela";
              }
              if ((country == "Portugal") && (region == "Regiao Autonoma da Madeira")) {
                region = "Madeira";
              }
              if (country.indexOf("Republic of") == 0) {
                country = country.replace("Republic of", "").trim();
              }
              let comma_idx = country.indexOf(", ");
              if (comma_idx >= 4) {
                country = country.substring(0, comma_idx).trim();
              }

              // Set location form fields
              // ************************

              console.log(country);
              document.getElementById('form_country_id').value = country;
              console.log(region);
              document.getElementById('form_region_id').value = region;
              console.log(zip);
              document.getElementById('form_zip_id').value = zip;
              console.log(city);
              document.getElementById('form_city_id').value = city;
              console.log((locationId + " " + extraLocationInfo).trim());
              document.getElementById('form_geoloc_id').value = (locationId + " " + extraLocationInfo).trim();
              console.log(timezone);
              document.getElementById('form_timezone_id').value = timezone;
              console.log(latitude);
              document.getElementById('form_latitude_id').value = latitude;
              console.log(longitude);
              document.getElementById('form_longitude_id').value = longitude;
              console.log(ipaddress);
              document.getElementById('form_ipaddress_id').value = ipaddress;

              // Store location data for future usage
              // ************************************

              last_location_data_used = data_p; // (store complete structure)
              id_of_last_location_data_used = locationId;

              localStorage.latitude = latitude; // (local storage of most useful location information)
              localStorage.longitude = longitude;
              localStorage.countryname = country;
              localStorage.region = region;
              localStorage.city = city;
              localStorage.ip = ipaddress;
              localStorage.location_id = locationId;

              // Other fields
              // ************

              let playerid;
              let firstname = "-"; // (firstname may stay equal to this default value if not defined)
              if (localStorage.firstname) {
                firstname = localStorage.firstname;
              }
              if (!localStorage.playerid) {
                let id = makeid() + formatDate(new Date());
                localStorage.playerid = id;
              }
              playerid = playerid_prefix + localStorage.playerid;

              console.log(playerid);
              document.getElementById('form_playerid_id').value = playerid;
              console.log(firstname);
              document.getElementById('form_firstname_id').value = firstname;
              console.log(nbcolumns);
              document.getElementById('form_nbcolumns_id').value = nbcolumns;
              console.log(score);
              document.getElementById('form_score_id').value = score;
              console.log(attempts);
              document.getElementById('form_attempts_id').value = attempts;
              console.log(timestr);
              document.getElementById('form_time_id').value = timestr;
              console.log(perfs);
              document.getElementById('form_perfs_id').value = perfs;
              console.log(nbuknperfs);
              document.getElementById('form_nbuknperfs_id').value = nbuknperfs;
              console.log(help);
              document.getElementById('form_help_id').value = help;
              console.log(gamesok);
              document.getElementById('form_gamesok_id').value = gamesok;
              console.log(deltagames);
              document.getElementById('form_deltagames_id').value = deltagames;

              console.log(navigator.platform);
              document.getElementById('form_platform_id').value = navigator.platform;
              console.log(navigator.language);
              document.getElementById('form_browserlanguage_id').value = navigator.language;
              console.log(userAgentStr);
              document.getElementById('form_useragent_id').value = userAgentStr;
              document.getElementById('form_href_id').value = decodeURI(location.href);
              document.getElementById('form_formsubmitdate_id').value = new Date();

              var extra_debug_info = "";
              try {
                extra_debug_info = extra_debug_info + "/Game:" + gamestr;
                if (typeof(Storage) !== 'undefined') {
                  if (localStorage.html_geoloc_status) {
                    extra_debug_info = extra_debug_info + "/html_geoloc_status:" + localStorage.html_geoloc_status;
                  }
                  if (localStorage.previousfirstname) {
                    extra_debug_info = extra_debug_info + "/PreviousFirstName:" + localStorage.previousfirstname;
                  }
                }
                extra_debug_info = extra_debug_info + "/Cookies:" + navigator.cookieEnabled;
                extra_debug_info = extra_debug_info + "/Java:" + navigator.javaEnabled();
                var pluginsLength = navigator.plugins.length; // (Note: plugin listing is no longer allowed in Firefox for security reasons => length will be less than the actual value)
                extra_debug_info =  extra_debug_info + "/Plugins:" + pluginsLength;
                if (pluginsLength > 0) {
                  for (var i = 0; i < pluginsLength; i++) {
                    extra_debug_info = extra_debug_info + "|" + i + ":" + navigator.plugins[i].filename + (navigator.plugins[i].version ? navigator.plugins[i].version : "");
                  }
                }
                extra_debug_info = extra_debug_info + "/MimeTypes:" + navigator.mimeTypes.length;
              }
              catch (exc) {}
              var firstNameAskedStr = "0x";
              var androidAppNotifShownStr = "0x";
              var firstAccessIdStr = "-";
              if (typeof(Storage) !== 'undefined') {
                if (localStorage.firstnameAsked) {
                  firstNameAskedStr = localStorage.firstnameAsked + "x"; // (past game counter to simplify)
                }
                if (localStorage.androidAppNotifShown) {
                  androidAppNotifShownStr = localStorage.androidAppNotifShown + "x";
                }
                if (localStorage.firstaccessid) {
                  firstAccessIdStr = localStorage.firstaccessid;
                }
              }
              document.getElementById('form_debuginfo_id').value = getLocation() + '/Screen:' + screen.width + '*' + screen.height + ',' + screen.colorDepth + '/Inner:' + window.innerWidth + "*" + window.innerHeight + '/' + html_compatibility_game_version + '/FirstNameAsked:' + firstNameAskedStr + '/androidAppNotifShown:' + androidAppNotifShownStr + '/FirstAccessId:' + firstAccessIdStr + '/NbGamesWon: ' + nbGamesPlayedAndWon + extra_debug_info;

              document.getElementById('form_rankings_id').value = '-';
              document.getElementById('form_list_id').value = '-';

              var form_to_be_submitted = true;
              if (typeof(Storage) !== 'undefined') {
                if ( (!localStorage.firstname)
                     && (gamesok >= 4) // (coherent with "history_clear_advice")
                     && (attempts >= 4) // (game not too easy)
                     && ( (gamesok <= 5) || ((gamesok % 2) == 1) ) // (do not ask first name too often if not filled / ignore 1 result out of 2)
                     && ( ((nbcolumns == 4) && (score >= 55)) || ((nbcolumns == 5) && (score >= 60)) || ((nbcolumns == 6) && (score >= 110)) || ((nbcolumns == 7) && (score >= 130))
                          || ((gamesok >= 7) && (score >= 44))
                          || ((gamesok >= 13) && (score >= 25)) ) ) { // (experienced player)
                  try {
                    // ***** Modal-based version does not work with android appli due to zoom issues:
                    // modal_mode = 1;
                    // // set modal content
                    // // NOTE: vw unit is used instead of vh for font-size due to interactive smartphone keyboards which reduce window height
                    // modal.setContent("<div style='-webkit-touch-callout: none; /* iOS Safari */ -webkit-user-select: none; /* Safari */ -khtml-user-select: none; /* Konqueror HTML */ -moz-user-select: none; /* Firefox */ -ms-user-select: none; /* Internet Explorer/Edge */ user-select: none; /* Non-prefixed version, currently supported by Chrome and Opera */'>"
                    //                 + "<hr style='height:3.0vh;padding:0;margin:0;visibility:hidden;'><font style='font-size:calc(18px + .34vw);'><b>You seem to be an experienced player!<br>"
                    //                 + "Please enter your first name, it will be used to store your scores</b></font><hr style='height:3.0vh;padding:0;margin:0;visibility:hidden;'>"
                    //                 + "<font style='font-size:calc(15px + .34vw)'>Your first name (between 3 and 11 letters, no spaces):</font><hr style='height:1.0vh;padding:0;margin:0;visibility:hidden;'>"
                    //                 + "<input id='firstname_input' type='text' value='Sherlock?' maxlength='11' style='font-size:calc(18px + .34vw)'></input><hr style='height:3.0vh;padding:0;margin:0;visibility:hidden;'>"
                    //                 + (android_appli ? "" : "<font style='font-size:calc(15px + .34vw)'>To store your future scores properly (with your first name), make sure that your browser does not clear cookies/site data when exited</font><br>")
                    //                 + "<font style='font-size:calc(15px + .34vw)'>Close this dialog to skip this step</font><hr style='height:3.0vh;padding:0;margin:0;visibility:hidden;'>"
                    //                 + "</div>");
                    // // open modal
                    // modal.open();
                    // form_to_be_submitted = false; // form to be submitted when modal is closed

                    // ***** Prompt-based version:
                    let firstname_entered = prompt("Please enter your first name, it will be used to store your future scores (between 3 and 11 letters, no spaces):", "Sherlock?");
                    if (firstname_entered != null) { // (a first name was entered)
                      firstname_entered = firstname_entered.trim();
                      if ( (firstname_entered.length >= 3) && (firstname_entered.length <= 11) && (/^[A-Za-zÀ-ÿ'-]+$/.test(firstname_entered)) /* (only letters) */ && isCorrect(firstname_entered) ) {
                        if (typeof(Storage) !== 'undefined') {
                          localStorage.firstname = capitalizeFirstLetters(firstname_entered);
                        }
                      }
                      else {
                        if (typeof(Storage) !== 'undefined') {
                          localStorage.previousfirstname = firstname_entered;
                        }
                        alert("Invalid first name: " + firstname_entered);
                      }
                    }

                    if (typeof(Storage) !== 'undefined') {
                      if (!localStorage.firstnameAsked) {
                        localStorage.firstnameAsked = 0;
                      }
                      localStorage.firstnameAsked = Number(localStorage.firstnameAsked) + 1;
                      if (localStorage.firstname) {
                        console.log("new firstname: " + localStorage.firstname);
                        document.getElementById('form_firstname_id').value = localStorage.firstname;
                      }
                    }

                  }
                  catch (exc) {
                    throw new Error("first name entry error: " + exc + ": " + exc.stack);
                  }
                }
              }

              if (form_to_be_submitted) {
                submitForm();
              }
              else {
                console.log("(form submission skipped)");
              }

            }, // setFormInfoWithValidLocationData

            setFormInfoByOtherMeans: function() {

              // Regularly attempt HTML geolocation
              // **********************************

              if (typeof(Storage) !== 'undefined') {
                // Subject to user acceptance => not done systematically because may prevent all future requests in case of initial rejection
                // Done at most once out of 2 to allow usage of previously stored location data without repetitive HTML geolocation attempt(s)
                if (localStorage.gamesok && (Number(localStorage.gamesok) >= (android_appli ? 1 : 8)) && (Number(localStorage.gamesok) > html_geoloc_next_gamesok + 7)) {
                  html_geoloc_next_gamesok = Number(localStorage.gamesok) + 1; // (*)
                  if ( ((!localStorage.html_geoloc_status) || (localStorage.html_geoloc_status.indexOf('ok') != 0))
                       && (!android_appli) ) {
                    alert("If you accept to share your location, your country and city names will be used to store your future scores (location sharing is part of your browser settings)");
                  }
                  attempt_HTML_geolocation(); // Subject to user acceptance
                }
              }
              // (*) To simplify, this geolocation will be taken into account at next calls if accepted by the user (localStorage.xxx values will be updated)

              // Use previously stored location data if any
              // ******************************************

              if (localStorage.latitude && localStorage.longitude && localStorage.countryname && localStorage.region && localStorage.city && localStorage.ip && localStorage.location_id) {
                let stored_location_data = { latitude: localStorage.latitude,
                                             longitude: localStorage.longitude,
                                             country_name: localStorage.countryname,
                                             region: localStorage.region,
                                             city: localStorage.city,
                                             ip: localStorage.ip };
                if (!isLocationDataValid(stored_location_data)) {
                  throw new Error("setFormInfoByOtherMeans: invalid stored location data: " + JSON.stringify(stored_location_data));
                }
                geolocation_handler.setFormInfoWithValidLocationData(stored_location_data, localStorage.location_id, "ST");
              }
              else {
                alert("Oops... your score could not be stored properly due to geolocation failure!");
                let dummy_location_data = { latitude: '0.0',
                                            longitude: '0.0',
                                            country_name: 'unknown',
                                            region: 'unknown',
                                            city: 'unknown',
                                            ip: '0.0.0.0' };
                if (!isLocationDataValid(dummy_location_data)) {
                  throw new Error("setFormInfoByOtherMeans: invalid dummy location data: " + JSON.stringify(dummy_location_data));
                }
                geolocation_handler.setFormInfoWithValidLocationData(dummy_location_data, 0, "DU");
              }

            }, // setFormInfoByOtherMeans

            setFormInfo: function() {

              // Use very fine location data if any
              // **********************************

              if (very_fine_location_data != null) {
                if (isLocationDataValid(very_fine_location_data)) {
                  geolocation_handler.setFormInfoWithValidLocationData(very_fine_location_data, nbLocationURLs + 11, "VF");
                  return;
                }
              }

              // Use last valid location data if any
              // ***********************************

              if ((id_of_last_location_data_used > 0) && isLocationDataValid(last_location_data_used)) {
                geolocation_handler.setFormInfoWithValidLocationData(last_location_data_used, id_of_last_location_data_used, "LA");
                return;
              }

              // Fetch location data from distant sites
              // **************************************

              if (geolocation_handler.nb_JSON_queries_posted >= nbLocationURLs) {
                throw new Error("setFormInfo: inconsistent nb_JSON_queries_posted value: " + geolocation_handler.nb_JSON_queries_posted + ", " + nbLocationURLs);
              }
              let locationURL = locationURLs[geolocation_handler.nb_JSON_queries_posted];

              geolocation_handler.nb_JSON_queries_posted++;
              let current_nb_JSON_queries_posted = geolocation_handler.nb_JSON_queries_posted;
              debug_game_state = 20;
              $.getJSON(locationURL)
              .done(function(data) { // Success case
                debug_game_state = 21;
                let converted_data = geolocation_handler.convertLocationData(data, current_nb_JSON_queries_posted);
                if (isLocationDataValid(converted_data)) {
                  geolocation_handler.setFormInfoWithValidLocationData(converted_data, current_nb_JSON_queries_posted, "");
                }
                else {
                  var errorStr = "invalid geolocation #" + current_nb_JSON_queries_posted + ": " + JSON.stringify(data);
                  console.log(errorStr);
                  if (current_nb_JSON_queries_posted < nbLocationURLs) {
                    geolocation_handler.setFormInfo(); // (recursive call)
                  }
                  else {
                    geolocation_handler.setFormInfoByOtherMeans();
                  }
                }
                debug_game_state = 22;
              })
              .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
                debug_game_state = 23;
                var errorStr = ("geolocation failure #" + current_nb_JSON_queries_posted + ": " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
                console.log(errorStr);
                if (current_nb_JSON_queries_posted < nbLocationURLs) {
                  geolocation_handler.setFormInfo(); // (recursive call)
                }
                else {
                  geolocation_handler.setFormInfoByOtherMeans();
                }
                debug_game_state = 24;
              })
              .always(function() {
                debug_game_state = 25;
                console.log("(getJSON completed #" + current_nb_JSON_queries_posted + ")");
                debug_game_state = 26;
              });

            } // setFormInfo

          } // geolocation_handler

          geolocation_handler.setFormInfo(); // (main call)

          console.log("(store player info exit)");
          debug_game_state = 101;
        }
        catch (exc) {
          debug_game_state = 102;
          console.log("internal error while storing scores: " + exc);
          if (nb_errors_submitted == 0) {
            // alert("Oops... an internal error occurred: " + exc);
            var errorStr = "";
            if (typeof(Storage) !== 'undefined') {
              if (localStorage.firstname) {
                errorStr = errorStr + " for " + localStorage.firstname;
              }
              if (localStorage.firstaccessid) {
                errorStr = errorStr + " for first access id " + localStorage.firstaccessid;
              }
            }
            errorStr = errorStr + " on " + navigator.platform + " / " + userAgentStr + " / " + decodeURI(location.href);
            submitForm("internal error while storing scores" + errorStr + ": " + exc, true);
            nb_errors_submitted++;
          }
          debug_game_state = 103;
        }

      } // store_player_info

      var attempt_HTML_geolocation_already_done = false;
      function attempt_HTML_geolocation_if_needed() {
        if (!attempt_HTML_geolocation_already_done) {
          if (android_appli) { // ACCESS_FINE_LOCATION is requested in android appli (subject to user acceptance)
            setTimeout("attempt_HTML_geolocation();", 1111); // Redone after each page/webview reload at "first user interaction" (subject to user acceptance - "first user interaction" means the user has responded (yes or no) to the ACCESS_FINE_LOCATION request, which then allows him to interact with the game)
            attempt_HTML_geolocation_already_done = true;
          }
        }
      }

      // ***********************
      // Handle page access info
      // ***********************

      var initial_time = new Date().getTime();
      function submitAccessForm(data, access_type, debug_info) {
        var final_time = new Date().getTime();
        if (final_time - initial_time > 999000) { // 15min+delta max - See (**)
          return;
        }
        var timeStr = String(Math.floor((final_time - initial_time)/1000));
        if (access_type.indexOf(" in") != -1) {
          timeStr = "";
        }
        var countryNameStr = "-";
        if ((data != null) && (typeof data.country_name != 'undefined') && (data.country_name != null)) {
          countryNameStr = String(data.country_name).trim();
        }
        var regionNameStr = "-";
        if ((data != null) && (typeof data.region != 'undefined') && (data.region != null)) {
          regionNameStr = String(data.region).trim();
        }
        var cityNameStr = "-";
        if ((data != null) && (typeof data.city != 'undefined') && (data.city != null)) {
          cityNameStr = String(data.city).trim();
        }
        var ipAddressStr = "-";
        if ((data != null) && (typeof data.ip != 'undefined') && (data.ip != null)) {
          ipAddressStr = String(data.ip).trim();
        }
        var firstAccessIdStr = "-";
        if (typeof(Storage) !== 'undefined') {
          if (localStorage.firstaccessid) {
            firstAccessIdStr = localStorage.firstaccessid;
          }
        }
        var debugStr = "firstgeoloc:" + localStorage.firstgamegeoloc + "/" + userAgentStr + "/initial: " + initial_time + "/final: " + final_time + "/debug_info:" + debug_info;
        var nbColorSelectionsStr = ((nbColorSelections == 0) ? "(-)" : "(" + String(nbColorSelections) + ")");
        var gameRulesDisplayedStr = (gameRulesDisplayed ? "(r)" : "");
        submitForm('-&' + 'page=' + access_type + '&' + 'timeonpage=' + timeStr + '&' + 'country=' + countryNameStr + '&region=' + regionNameStr + '&city=' + cityNameStr + '&nbgameswon=' + ((nbGamesPlayedAndWon==0)?"-":String(nbGamesPlayedAndWon)) + '&nbgames=' + ((nbGamesPlayed==0)?"-":String(nbGamesPlayed)) + '&nbcodes=' + ((nbCodesPlayed==0)?"-":String(nbCodesPlayed)) + " " + nbColorSelectionsStr + " " + gameRulesDisplayedStr + '&ipaddress=' + ipAddressStr + '&firstaccessid=' + firstAccessIdStr + '&debug=' + debugStr, true);
      }

      function storeFirstAccess(access_type, timeToWait1, timeToWait2, debug_info) {
        if (firstAccess) {
          // Keep some time between the 2 potential calls to submitAccessForm()
          let now = new Date().getTime();
          while(new Date().getTime() < now + timeToWait1){}; // (interface is frozen during this short time)
          if ((id_of_last_location_data_used > 0) && (last_location_data_used != null)) {
            submitAccessForm(last_location_data_used, access_type, debug_info);
          }
          else {
            submitAccessForm(null, access_type, debug_info);
          }
          // Keep some time between the 2 potential calls to submitAccessForm()
          now = new Date().getTime();
          while(new Date().getTime() < now + timeToWait2){}; // (interface is frozen during this short time)
        }
      }

      function firstAccessGeolocFailure(jqxhr, textStatus, error) {
        var errorStr = ("first access geolocation failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
        console.log(errorStr);
        debug_game_state = 30;
        $.getJSON(locationURLs[1], function(data_p) {
          debug_game_state = 31;
          localStorage.firstgamegeoloc = "fa2";
          /* ipinfodb.com response format:
             - SUCCESS case:
              statusCode	"OK"
              statusMessage	""
              ipAddress	"94.239.111.222"
              countryCode	"FR"
              countryName	"France"
              regionName	"Ile-de-France"
              cityName	"Paris"
              zipCode	"75000"
              latitude	"48.8534"
              longitude	"2.3488"
              timeZone	"+01:00"
            - FAILURE case:
              statusCode	"ERROR"
              statusMessage	"Invalid IP Address."
              ipAddress	"994.239.111.222"
              countryCode	""
              countryName	""
              regionName	""
              cityName	""
              zipCode	""
              latitude	"0"
              longitude	"0"
              timeZone	""
          */
          let converted_data = JSON.stringify(data_p);

          // latitude -> latitude
          // longitude -> longitude
          // countryName -> country_name
          converted_data = converted_data.replace("\"countryName\":", "\"country_name\":");
          // regionName -> region
          converted_data = converted_data.replace("\"regionName\":", "\"region\":");
          // cityName -> city
          converted_data = converted_data.replace("\"cityName\":", "\"city\":");
          // ipAddress -> ip
          converted_data = converted_data.replace("\"ipAddress\":", "\"ip\":");

          last_location_data_used = JSON.parse(converted_data);
          id_of_last_location_data_used = 2;
          // storeFirstAccess('game', 444, 444 /* (a too low value here will not work) */, 'debug-ok2');
          debug_game_state = 32;
        })
        .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
          debug_game_state = 33;
          localStorage.firstgamegeoloc = "faerr2";
          var errorStr = ("first access geolocation retry failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
          console.log(errorStr);
          // storeFirstAccess('game', 444, 444 /* (a too low value here will not work) */, 'debug-fail');
          debug_game_state = 34;
        })
        .always(function() {
          debug_game_state = 35;
          console.log("(getJSON completed #i2)");
          debug_game_state = 36;
        });
      }

      if (firstAccess) {
        debug_game_state = 40;
        $.getJSON(locationURLs[0], function(data) {
          debug_game_state = 41;
          localStorage.firstgamegeoloc = "fatmp1";
          last_location_data_used = data;
          id_of_last_location_data_used = 1;
          if ( ((typeof data.ip != 'undefined') && (data.ip != null) && (String(data.ip).trim().length >= 7 /* 0.0.0.0 */)) // (redundant lines)
               && ((typeof data.city != 'undefined') && (data.city != null) && (String(data.city).trim().length >= 2)) ) { // (redundant lines)
            localStorage.firstgamegeoloc = "fa1";
            // storeFirstAccess('game', 444, 444 /* (a too low value here will not work) */, 'debug-ok1');
          }
          else {
            localStorage.firstgamegeoloc = "faerr1a";
            return firstAccessGeolocFailure("", "manual first access geolocation retry due to invalid geolocation data", "");
          }
          debug_game_state = 42;
        }) // to simplify, failure cases are not handled in a more complex way
        .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
          debug_game_state = 43;
          localStorage.firstgamegeoloc = "faerr1b";
          firstAccessGeolocFailure(jqxhr, textStatus, error);
          debug_game_state = 44;
        })
        .always(function() {
          debug_game_state = 45;
          console.log("(getJSON completed #i1)");
          debug_game_state = 46;
        });

        // Too close calls can lead to Cross-Origin Read Blocking (CORB) security error in Chrome (https://www.chromestatus.com/feature/5629709824032768) which will block further form submissions
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-30s')",     30000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-1min')",    60000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-2min')",   120000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-5min')",   300000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-10min')",  600000);
        setTimeout("storeFirstAccess('game', 0, 0, 'debug-15min')",  900000); // See (**)
      }

      // *********************************************
      // Load GameSolver and Super Master Mind scripts
      // *********************************************

      function loadSuperMasterMindScript() {
        debug_game_state = 60;
        jQuery.ajax({
          url: "SuperMasterMind.js",
          method: "GET",
          dataType: "script",
          mimeType: "application/javascript",
          timeout: 1800000, // 30 minutes (very high timeout value to attempt to avoid the error "GAME UNHANDLEDREJECTION ERROR / reason: SyntaxError: The string did not match the expected pattern." in some browsers without/before fail() function being entered - Note: timeout = 0 does not solve it)
          xhr: function() {
            var xhr = new window.XMLHttpRequest();
            // Upload progress
            xhr.upload.addEventListener("progress", function(evt) {
              if (evt.lengthComputable && (evt.total > 0)) {
                var ratioComplete = evt.loaded / evt.total;
                console.log("progress upload: " + ratioComplete);
              }
              else {
                console.log("progress upload: " + evt.lengthComputable + ", " + evt.loaded + ", " + evt.total);
              }
            }, false);
            // Download progress
            xhr.addEventListener("progress", function(evt) {
              // if (evt.lengthComputable) { -> works in Firefox but always false in Chrome when the HTML page is distant
              if (evt.loaded > 0) {
                var ratioComplete;
                var ratioDebugStr;
                if (evt.lengthComputable && (evt.total > 0)) {
                  ratioComplete = evt.loaded / evt.total;
                  ratioDebugStr = "";
                }
                else {
                  ratioComplete = Math.min(1.0, evt.loaded / loaded_sizes[2]); // (simplification useful for Chrome when the HTML page is distant)
                  ratioDebugStr = " (s)";
                }
                var globalProgress = getGlobalProgress(ratioComplete, 2);
                console.log("current progress: " + globalProgress + "%" + ratioDebugStr); // !WARNING! -> this console text will be read by the android appli so shall not be modified
                if (globalProgress > 0) {
                  $("#game_loading_id").html("<img src='img/loading.gif' style='height:12%;'><br>Loading (" + globalProgress + "%)"); // (not rem unit as no viewport! / duplicated code)
                }
              }
              else {
                console.log("progress: " + evt.lengthComputable + ", " + evt.loaded + ", " + evt.total);
              }
            }, false);
            return xhr;
          }
        })
        .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
          debug_game_state = 61;
          var errorStr = ("SuperMasterMind script load failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
          console.log(errorStr);
          alert("Oops... a network error occurred!\nPlease retry...\n\n" + "(" + errorStr + ")");
          debug_game_state = 62;
        })
        .always(function() {
          debug_game_state = 63;
          console.log("(on scripts load)"); // !WARNING! -> this console text will be read by the android appli so shall not be modified
          $(".game_loading").fadeOut("slow"); // game_loading div fades out
          debug_game_state = 64;
          // $("#my_all_scripts_loaded_form").submit(); // (dummy form submission for android appli's web view)
          debug_game_state = 65;
        });
      }

      var globalProgressForHTMLGame3 = getGlobalProgress(0.99 /* (rough value) */, 0);
      console.log("current progress: " + globalProgressForHTMLGame3 + "% (g)"); // !WARNING! -> this console text will be read by the android appli so shall not be modified
      if (globalProgressForHTMLGame3 > 0) {
        $("#game_loading_id").html("<img src='img/loading.gif' style='height:12%;'><br>Loading (" + globalProgressForHTMLGame3 + "%)"); // (not rem unit as no viewport! / duplicated code)
      }

      let gamesolver_blob = null;
      let gamesolver_blob_error = "NA";
      debug_game_state = 70;
      jQuery.ajax({
        url: "GameSolver.js",
        method: "GET",
        dataType: "script",
        mimeType: "application/javascript",
        timeout: 1800000, // 30 minutes (very high timeout value to attempt to avoid the error "GAME UNHANDLEDREJECTION ERROR / reason: SyntaxError: The string did not match the expected pattern." in some browsers without/before fail() function being entered - Note: timeout = 0 does not solve it)
        xhr: function() {
          var xhr = new window.XMLHttpRequest();
          // Upload progress
          xhr.upload.addEventListener("progress", function(evt) {
            if (evt.lengthComputable && (evt.total > 0)) {
              var ratioComplete = evt.loaded / evt.total;
              console.log("progress upload: " + ratioComplete);
            }
            else {
              console.log("progress upload: " + evt.lengthComputable + ", " + evt.loaded + ", " + evt.total);
            }
          }, false);
          // Download progress
          xhr.addEventListener("progress", function(evt) {
            // if (evt.lengthComputable) { -> works in Firefox but always false in Chrome when the HTML page is distant
            if (evt.loaded > 0) {
              var ratioComplete;
              var ratioDebugStr;
              if (evt.lengthComputable && (evt.total > 0)) {
                ratioComplete = evt.loaded / evt.total;
                ratioDebugStr = "";
              }
              else {
                ratioComplete = Math.min(1.0, evt.loaded / loaded_sizes[1]); // (simplification useful for Chrome when the HTML page is distant)
                ratioDebugStr = " (s)";
              }
              var globalProgress = getGlobalProgress(ratioComplete, 1);
              console.log("current progress: " + globalProgress + "%" + ratioDebugStr); // !WARNING! -> this console text will be read by the android appli so shall not be modified
              if (globalProgress > 0) {
                $("#game_loading_id").html("<img src='img/loading.gif' style='height:12%;'><br>Loading (" + globalProgress + "%)"); // (not rem unit as no viewport! / duplicated code)
              }
            }
            else {
              console.log("progress: " + evt.lengthComputable + ", " + evt.loaded + ", " + evt.total);
            }
          }, false);
          return xhr;
        }
      })
      .done(function(data) { // Success case
        debug_game_state = 71;
        // console.log(data); // data contains GameSolver script contents
        gamesolver_blob = new Blob([data], {type: "application/javascript"});
        // Super Master Mind script is only loaded once GameSolver script has been loaded successfully
        setTimeout("loadSuperMasterMindScript();", 44);
        debug_game_state = 72;
      })
      .fail(function(jqxhr, textStatus, error) { // (jqxhr: XMLHTTPRequest)
        debug_game_state = 73;
        var errorStr = ("GameSolver script load failure: " + textStatus + " " + error + " " + str_from_jqxhr(jqxhr)).trim();
        console.log(errorStr);
        gamesolver_blob_error = errorStr;
        // Super Master Mind script is loaded and will raise an error because GameSolver script has not been loaded successfully
        // setTimeout("loadSuperMasterMindScript();", 44);
        alert("Oops... a network error occurred!\nPlease retry...\n\n" + "(" + errorStr + ")");
        $(".game_loading").fadeOut("slow"); // game_loading div fades out
        debug_game_state = 74;
      });

    </script>

    <p id='traces_id' style='color:#AAAAAA;'></p>

  </body>

</html>
